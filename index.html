<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Discernment Flow Chart</title>

<!-- ⚖️ emoji favicon -->
<link rel="icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Ctext y='.9em' x='.08em' font-size='90'%3E%E2%9A%96%EF%B8%8F%3C/text%3E%3C/svg%3E">

<style>
  body { font-family: Arial, sans-serif; background: #f7f7f7; margin:0; padding:0; }
  .container { max-width: 650px; margin:auto; padding:20px; }
  .top-bar { display:flex; justify-content:space-between; margin-bottom:10px; }
  .card {
    background:#fff; padding:20px; border-radius:8px;
    box-shadow:0 2px 6px rgba(0,0,0,0.1); min-height:280px;
    display:flex; flex-direction:column; justify-content:space-between;
  }

  /* Header / segment heading row (left label + right skip) */
  .segment-heading {
    display:flex; align-items:center; justify-content:space-between;
    font-size:1.4em; font-weight:bold; margin-bottom:15px; padding:8px;
    border-bottom:2px solid #ddd; gap:12px;
    transition: background-color .5s ease, color .5s ease;
  }
  .segment-title { display:inline-flex; align-items:center; gap:8px; }
  .flash-gold { background-color:gold !important; color:#fff !important; }   /* WHEN */
  .flash-green { background-color:#2e7d32 !important; color:#fff !important;} /* IF */

  .skip-btn {
    flex:0 0 auto; padding:6px 10px; font-size:0.9em;
    border:none; border-radius:5px; cursor:pointer;
    background:#e9e9e9; color:#333;
  }
  .skip-btn:hover { background:#dedede; }

  .text { font-size:1.2em; margin-bottom:12px; white-space:pre-wrap; }

  /* Controls just under the text */
  .controls-row { display:flex; gap:8px; flex-wrap:wrap; margin:6px 0 18px 0; }
  .examples-toggle, .reasoning-toggle { display:flex; gap:8px; flex-wrap:wrap; }
  .panel {
    display:none; border:1px solid #eee; border-radius:6px; padding:10px; background:#fafafa;
    margin-bottom: 18px; /* space above bottom buttons */
  }
  .panel p { margin:6px 0; }
  .panel img { width:100%; height:auto; display:block; }

  /* Buttons row at bottom */
  .buttons { display:flex; gap:10px; flex-wrap:wrap; justify-content:flex-start; }
  .buttons.center { justify-content:center; }

  /* Buttons */
  button { flex:1; padding:10px; font-size:1em; border:none; border-radius:5px; cursor:pointer; }
  button.yes { background:#4CAF50; color:#fff; }
  button.no { background:#F44336; color:#fff; }
  button.next { background:#2196F3; color:#fff; }
  button.back { background:#555; color:#fff; flex:0 0 auto; }
  button.restart { background:#9C27B0; color:#fff; flex:0 0 auto; }
  button.examples-btn, button.viz-btn, button.reasoning-btn { background:#9E9E9E; color:#fff; flex:0 0 auto; }
  button.active { outline: 2px solid #000; }

  /* Q26: centered number + slider with ticks */
  .risk-inline { display:none; border:1px solid #eee; border-radius:6px; padding:12px; background:#fafafa; margin:8px 0 18px 0; }
  .sev-display { text-align:center; font-size:1.8em; font-weight:bold; margin-bottom:8px; }
  .risk-row { display:flex; align-items:center; gap:10px; margin:0; }
  .risk-row input[type="range"] { width:100%; }
  .risk-ticks { display:block; width:100%; }

  .error { color:#B00020; font-size:0.95em; margin-top:8px; }
</style>
</head>
<body>
<div class="container">
  <div class="top-bar">
    <button class="back" id="backBtn" onclick="goBack()">Back</button>
    <button class="restart" id="restartTop" onclick="restart()">Restart</button>
  </div>

  <div class="card">
    <div id="segmentHeading" class="segment-heading">
      <span id="segmentTitle" class="segment-title"></span>
      <button id="skipBtn" class="skip-btn" style="display:none;" title="Skip to when you should act">Skip ⏭</button>
    </div>

    <div>
      <div id="text" class="text"></div>

      <!-- Controls placed close to text -->
      <div class="controls-row">
        <div id="reasoningToggleWrapper" class="reasoning-toggle"></div>
        <div id="examplesToggleWrapper" class="examples-toggle"></div>
      </div>

      <!-- Shared panel (examples OR Q15/Q17 visualization) -->
      <div id="sharedPanel" class="panel" aria-hidden="true"></div>

      <!-- Always-visible risk slider on Q26 -->
      <div id="riskInline" class="risk-inline" aria-hidden="true"></div>

      <!-- Percentage reasoning panel (R8/R9 only) -->
      <div id="reasoningPanel" class="panel" aria-hidden="true"></div>

      <div id="errorBox" class="error"></div>
    </div>

    <div id="buttons" class="buttons"></div>
  </div>
</div>

<script>
// ======= FLOW (Q0–Q35) =======
// Intro screen (Q0), then your updated wording.
const flowchart = [
  /* START SCREEN */
  { "id": "Q0", "type": "info",
    "text": "Welcome! This tool helps you decide both IF and WHEN to act on an issue.\nYou’ll answer simple Yes/No questions (and a severity slider later). Tap Next to begin.",
    "next": "Q1"
  },

  /* ===== IF YOU SHOULD ACT (Q1–Q23) ===== */
  { "id": "Q1",  "type": "question", "text": "Are there any other more important things to do or think about right now?", "yes": "R1", "no": "Q2" },
  { "id": "Q2",  "type": "question", "text": "Is there a known problem or desired QoL (quality of life) change that involves your needs and wants of a subject not being met functionally?", "yes": "Q5", "no": "Q3" },
  { "id": "Q3",  "type": "question", "text": "Is there cause for a potential problem that would directly affect your needs and wants of a subject not being met functionally?", "yes": "Q5", "no": "Q4" },
  { "id": "Q4",  "type": "question", "text": "Is there cause for a POTENTIAL cause for a POTENTIAL problem that would directly affect your needs and wants of a subject not being met functionally?", "yes": "Q5", "no": "R2" },
  { "id": "Q5",  "type": "question", "text": "Is there a solution to the problem/potential problem even if it’s currently unavailable (or a means of bringing about the QoL change)?", "yes": "Q6", "no": "R3" },
  { "id": "Q6",  "type": "question", "text": "Can this solution or QoL change be brought about by your influence?", "yes": "Q9", "no": "Q7" },
  { "id": "Q7",  "type": "question", "text": "Do everything in your power first to achieve the desired result, but know that past that it’s out of your hands, and worrying and obsessing won’t change anything and is unhealthy. Is there anything further you can do?", "yes": "Q9", "no": "Q8" },
  { "id": "Q8",  "type": "question", "text": "Is there an alternative solution that would solve the problem (or improve QoL) in a way that’s within your control or in a better overall way?", "yes": "R4", "no": "R2" },
  { "id": "Q9",  "type": "question", "text": "Does this solution or QoL change involve gaining information that would be valuable in the future?", "yes": "Q10", "no": "Q11" },
  { "id": "Q10", "type": "question", "text": "Would the information alone gained from doing this outweigh the downsides it would likely cause to make this happen?", "yes": "Q24", "no": "Q11" },
  { "id": "Q11", "type": "question", "text": "Is it worth your resources to solve it?", "yes": "Q13", "no": "Q12" },
  { "id": "Q12", "type": "question", "text": "Is there an alternative solution that would solve the problem (or improve QoL) in a way that’s worth it to you or in a better overall way?", "yes": "R4", "no": "R2" },
  { "id": "Q13", "type": "question", "text": "Would the benefits of addressing this issue likely outweigh any downsides it might likely cause?", "yes": "Q15", "no": "Q14" },
  { "id": "Q14", "type": "question", "text": "Is there an alternative solution that would solve the problem (or improve QoL) in a way that’s worth it to you or in a better overall way?", "yes": "R4", "no": "R2" },
  { "id": "Q15", "type": "question", "text": "Does addressing this issue involve a diminishing returns curve for effort applied?", "yes": "Q16", "no": "Q17" },
  { "id": "Q16", "type": "info",     "text": "Find the point of diminishing returns and stop there. If you tend to get absorbed in an activity, find an alternative approach that solves the problem or improves QoL without the addictive pull and possibly even in a better overall way. Use that better option whenever possible. If it’s unavailable, you may use the original approach—but only with a pre-set time limit and timer, after which you must stop and re-evaluate.", "next": "Q17" },
  { "id": "Q17", "type": "question", "text": "Does addressing this issue directly involve an inverted-U curve for specific effort applied with an objective sweet spot where clear information is available to you?", "yes": "Q18", "no": "Q19" },
  { "id": "Q18", "type": "info",     "text": "Wait until there aren’t any other more important things to do, then if it’s worth it to you, find that sweet spot. If not, put in as much effort as you deem worth it.", "next": "Q24" },
  { "id": "Q19", "type": "question", "text": "In practice, would a worthwhile functional difference likely be noticed if the problem/potential problem/QoL change was solved/prevented/changed (for example in a blind test compared side by side, and ignoring any differences irrelevant to the actual functionality of the intended purpose associated)?", "yes": "Q20", "no": "R2" },
  { "id": "Q20", "type": "question", "text": "Would solving/preventing it help get rid of/prevent the problem (or improve QoL) in the long term?", "yes": "Q24", "no": "Q21" },
  { "id": "Q21", "type": "question", "text": "Would solving/preventing it help get rid of/prevent the problem (or improve QoL) in the short term?", "yes": "Q22", "no": "R2" },
  { "id": "Q22", "type": "question", "text": "Is it logically worth solving/preventing EVERY time? (Or this time knowing it’s temporary?)", "yes": "Q24", "no": "Q23" },
  { "id": "Q23", "type": "question", "text": "Is there an alternative solution that would solve the problem (or improve QoL), in the long term or in a better overall way?", "yes": "R4", "no": "R2" },

  /* ===== WHEN YOU SHOULD ACT (Q24+) ===== */
  { "id": "Q24", "type": "question", "text": "Does this address a future problem?", "yes": "Q25", "no": "Q28" },
  { "id": "Q25", "type": "question", "text": "Does addressing this issue involve preventative maintenance?", "yes": "Q26", "no": "Q28" },

  /* Severity selection */
  { "id": "Q26", "type": "info", "text": "Set the catastrophic severity if you waited too long to act. (1-10)", "next": "Q27" },

  { "id": "Q27", "type": "question", "text": "Would there be guaranteed clear telltale signs of future functional failure before it actually happened, with a big enough window of time to address it properly in advance?", "yes": "R8", "no": "R9" },
  { "id": "Q28", "type": "question", "text": "Is this the best solution you know of assuming you could do it now?", "yes": "Q30", "no": "Q29" },
  { "id": "Q29", "type": "question", "text": "Have you considered all better solutions you know of?", "yes": "Q30", "no": "R4" },
  { "id": "Q30", "type": "question", "text": "Is this solution currently available?", "yes": "Q34", "no": "Q32" },
  { "id": "Q31", "type": "question", "text": "Is there a better time down the road to solve/address this to maximize value?", "yes": "Q32", "no": "R6" },
  { "id": "Q32", "type": "question", "text": "Assuming you waited until it was available, would the benefits of using this solution outweigh the downsides of having to wait?", "yes": "Q35", "no": "Q33" },
  { "id": "Q33", "type": "question", "text": "Is there a next best solution?", "yes": "R4", "no": "R3" },
  { "id": "Q34", "type": "question", "text": "Is there a better time further down the road to solve/address this to maximize value?", "yes": "R7", "no": "R6" },
  { "id": "Q35", "type": "question", "text": "Is there a better time further down the road than when this solution is available to solve/address this to maximize value?", "yes": "R7", "no": "R5" },

  /* RESULTS */
  { "id": "R1", "type": "result", "text": "Worry about this once those things are addressed and the time is right." },
  { "id": "R2", "type": "result", "text": "Don’t worry about it." },
  { "id": "R3", "type": "result", "text": "Wait until there aren’t any other more important things to do, then if it’s worth it to you, find a solution or solutions. If not, put in as much effort as you deem worth it." },
  { "id": "R4", "type": "result", "text": "Consider any other solutions, from best to worst, if you haven’t already. Run them through the chart." },
  { "id": "R5", "type": "result", "text": "Wait until the best solution given the circumstances is available, then solve it once there aren’t any other more important things to do." },
  { "id": "R6", "type": "result", "text": "Address it sooner than later, once there aren’t any other more important things to do." },
  { "id": "R7", "type": "result", "text": "Wait until that time, then solve/address it. Consider any other options that could also work and be worth it until then." },
  { "id": "R8", "type": "result", "text": "Wait until those signs are indicated, the expected downsides of not acting now outweigh the downsides of acting now, AND the estimated chance that current functional failure is nearing or greater than 50%, then solve/address it. Consider any ways to reduce the downsides and/or the likelihood of it failing." },
  { "id": "R9", "type": "result", "text": "Wait until the expected downsides of not acting now outweigh the downsides of acting now, AND the estimated chance that current functional failure is nearing or greater than 50%, then solve/address it. Consider any ways to reduce the downsides and/or the likelihood of it failing." }
];

// ===== EXAMPLES (Applies vs Does not apply) =====
const examples = {
  Q1:[ "Example 1: A major work/school deadline is today; deciding on a new TV can wait. (Applies here)",
       "Example 2: A free afternoon with no pressing tasks; you can consider smaller decisions now. (Does not apply here)"],
  Q2:[ "Example 1: The sink is leaking and wasting water—function isn’t being met. (Applies here)",
       "Example 2: Paint is slightly dull but everything works fine. (Does not apply here)"],
  Q3:[ "Example 1: Car battery struggles to start on cold mornings—likely to fail soon. (Applies here)",
       "Example 2: Phone works perfectly; you just feel uneasy it might break. (Does not apply here)"],
  Q4:[ "Example 1: Dust at the PC intake could clog the fan → overheating. (Applies here)",
       "Example 2: A vague future worry with no causal chain. (Does not apply here)"],
  Q5:[ "Example 1: A replacement faucet cartridge exists, even if backordered. (Applies here)",
       "Example 2: A software bug has no known fix or workaround yet. (Does not apply here)"],
  Q6:[ "Example 1: You can schedule a repair and approve payment. (Applies here)",
       "Example 2: A labor strike must resolve; you can’t influence it. (Does not apply here)"],
  Q7:[ "Example 1: You can escalate a ticket or try an official fix you skipped. (Applies here)",
       "Example 2: You’ve done all reasonable steps; more worrying won’t help. (Does not apply here)"],
  Q8:[ "Example 1: Switch to a simpler app that solves the need. (Applies here)",
       "Example 2: All alternatives rely on things you can’t control. (Does not apply here)"],
  Q9:[ "Example 1: Running diagnostics teaches prevention for next time. (Applies here)",
       "Example 2: A tedious workaround teaches nothing useful later. (Does not apply here)"],
  Q10:["Example 1: A quick medical screening offers value with minimal downside. (Applies here)",
       "Example 2: Disassembling a working device ‘just to see’ risks damage. (Does not apply here)"],
  Q11:["Example 1: A low-cost fix avoids a bigger expense later. (Applies here)",
       "Example 2: An expensive fix for a tiny convenience gain. (Does not apply here)"],
  Q12:["Example 1: Another shop offers same repair cheaper with warranty. (Applies here)",
       "Example 2: All other options are worse across time/cost/reliability. (Does not apply here)"],
  Q13:["Example 1: Repairing a roof leak prevents serious damage. (Applies here)",
       "Example 2: Risky modification voids warranty for marginal benefit. (Does not apply here)"],
  Q14:["Example 1: Replacing an old appliance is cheaper than repeated repairs. (Applies here)",
       "Example 2: No alternative beats the current plan. (Does not apply here)"],
  Q15:["Example 1: Polishing slides beyond ‘good enough’ adds little impact. (Applies here)",
       "Example 2: Fixing a critical bug—each hour matters; no early plateau. (Does not apply here)"],
  Q17:["Example 1: Exercise intensity has a sweet spot; too much/too little harms results. (Applies here)",
       "Example 2: Filing taxes—no optimal ‘intensity’; you just finish it. (Does not apply here)"],
  Q19:["Example 1: Upgrading HDD to SSD is clearly noticeable. (Applies here)",
       "Example 2: Gold-plated HDMI vs regular—no functional difference. (Does not apply here)"],
  Q20:["Example 1: Sealing driveway cracks extends lifespan. (Applies here)",
       "Example 2: A cosmetic fix that wears off in a week. (Does not apply here)"],
  Q21:["Example 1: Decongestant allows sleep tonight. (Applies here)",
       "Example 2: Reorganizing a drawer doesn’t change today’s urgent issue. (Does not apply here)"],
  Q22:["Example 1: Wearing a seatbelt is worth doing every time. (Applies here)",
       "Example 2: Washing the car daily isn’t worth it without special reason. (Does not apply here)"],
  Q23:["Example 1: Replacing a worn-out laptop beats another costly repair. (Applies here)",
       "Example 2: No alternative provides a better long-term outcome. (Does not apply here)"],
  Q24:["Example 1: Replacing a timing belt before expected lifespan ends. (Applies here)",
       "Example 2: Fixing a screen that already cracked (current problem, not future). (Does not apply here)"],
  Q25:["Example 1: Changing HVAC filters to prevent breakdowns. (Applies here)",
       "Example 2: Repainting a wall for a new color. (Does not apply here)"],
  Q27:["Example 1: Squealing brakes—clear warning sign. (Applies here)",
       "Example 2: Timing belt—can fail without warning. (Does not apply here)"],
  Q28:["Example 1: You’d pick this method if you could do it now. (Applies here)",
       "Example 2: You know a better option but aren’t choosing it. (Does not apply here)"],
  Q29:["Example 1: You compared and ruled out better options. (Applies here)",
       "Example 2: You haven’t checked obvious alternatives. (Does not apply here)"],
  Q30:["Example 1: Part is in stock; appointments available. (Applies here)",
       "Example 2: Part is backordered for two weeks. (Does not apply here)"],
  Q31:["Example 1: Off-season timing makes it cheaper and easier. (Applies here)",
       "Example 2: Waiting won’t improve value; risk may rise. (Does not apply here)"],
  Q32:["Example 1: Waiting a week saves a lot with little downside. (Applies here)",
       "Example 2: Waiting would cause outages or stress. (Does not apply here)"],
  Q33:["Example 1: A solid Plan B works now. (Applies here)",
       "Example 2: No next-best option reasonably solves it. (Does not apply here)"],
  Q34:["Example 1: Doing it during a scheduled break reduces disruption. (Applies here)",
       "Example 2: There’s no later window that beats now. (Does not apply here)"],
  Q35:["Example 1: After availability, doing it during a later lull saves hassle. (Applies here)",
       "Example 2: Once available, sooner is clearly better. (Does not apply here)"]
};

// ======= STATE (severity threshold) =======
// Default severity = 1 → threshold 90% (no localStorage).
let currentThresholdPct = 90;

// ======= APP LOGIC =======
let historyStack = [];
let currentNode = flowchart.find(n => n.id === "Q0");  // Start at intro
let currentSegment = "If You Should Act";               // default label
let lastNodeId = "Q0";                                  // track last node for intro→IF flash

function getSegmentForNodeId(id) {
  if (!id || id[0] !== 'Q') return currentSegment;
  const m = /^Q(\d+)$/.exec(id);
  if (!m) return currentSegment;
  const num = parseInt(m[1], 10);
  return num >= 24 ? "When You Should Act" : "If You Should Act";
}

function setHeadingText(nodeId) {
  const title = document.getElementById('segmentTitle');
  const skipBtn = document.getElementById('skipBtn');

  if (nodeId === 'Q0') {
    title.textContent = "⚖️ Discernment";
    skipBtn.style.display = 'none';
    return;
  }

  const text = (currentSegment === "If You Should Act")
    ? "⚖️ If You Should Act"
    : "⏳ When You Should Act";
  title.textContent = text;

  // Skip only in IF segment
  skipBtn.style.display = (currentSegment === "If You Should Act") ? 'inline-block' : 'none';
}

function flashHeadingColor(targetSegment) {
  const headingDiv = document.getElementById('segmentHeading');
  const cls = (targetSegment === "If You Should Act") ? 'flash-green' : 'flash-gold';
  headingDiv.classList.add(cls);
  setTimeout(() => headingDiv.classList.remove(cls), 1500);
}

/* ---- Dynamic clause helpers for R8/R9 ---- */
function buildThresholdClause() {
  if (currentThresholdPct <= 0) return 'there is even a small chance of failure';
  return `the estimated chance that current functional failure is nearing or greater than ${currentThresholdPct}%`;
}
function applyThresholdClauseTo(text) {
  const fullClause = /the estimated chance that current functional failure is nearing or greater than 50%/i;
  if (fullClause.test(text)) return text.replace(fullClause, buildThresholdClause());

  const fallbackClause = /nearing or greater than\s*50%/i;
  if (fallbackClause.test(text)) {
    const repl = (currentThresholdPct <= 0)
      ? 'even a small chance of failure'
      : `nearing or greater than ${currentThresholdPct}%`;
    return text.replace(fallbackClause, repl);
  }

  if (currentThresholdPct > 0) return text.replace(/50%/g, `${currentThresholdPct}%`);
  return text.replace(/0%/g, 'even a small chance of failure');
}

function renderNode(node) {
  const errorBox = document.getElementById('errorBox');
  errorBox.textContent = '';

  if (!node) {
    errorBox.textContent = "Error: Could not render this step (missing node). Check JSON IDs and links.";
    document.getElementById('text').textContent = '';
    document.getElementById('buttons').innerHTML = '';
    collapseSharedPanel(); collapseReasoningPanel();
    showOrHideRiskInline(null);
    document.getElementById('backBtn').style.visibility = historyStack.length > 0 ? 'visible' : 'hidden';
    setHeadingText(''); // keep whatever was set
    document.getElementById('restartTop').style.display = 'inline-block';
    return;
  }

  // Determine and apply segment AFTER entering node
  const prevId = lastNodeId;
  const thisSegment = getSegmentForNodeId(node.id);

  // Flash if segment changed OR if we're coming from Q0 into the IF segment
  const enteringIfFromIntro = (prevId === "Q0" && thisSegment === "If You Should Act");
  if (thisSegment !== currentSegment || enteringIfFromIntro) {
    flashHeadingColor(thisSegment); // green for IF, gold for WHEN
  }
  currentSegment = thisSegment;
  setHeadingText(node.id);

  // Main text (with dynamic clause for R8/R9)
  const textDiv = document.getElementById('text');
  let displayText = node.text || '';
  if (node.id === 'R8' || node.id === 'R9') {
    displayText = applyThresholdClauseTo(displayText);
  }
  textDiv.textContent = displayText;

  // Back button visibility
  document.getElementById('backBtn').style.visibility = historyStack.length > 0 ? 'visible' : 'hidden';

  // Examples / Viz controls & panel
  setupAuxToggles(node);

  // Reasoning (button near text) on R8/R9
  setupReasoning(node);

  // Risk slider inline on Q26 only
  showOrHideRiskInline(node);

  // Bottom buttons
  const btns = document.getElementById('buttons');
  btns.innerHTML = '';
  const restartTop = document.getElementById('restartTop');
  if (node.type === 'result') {
    restartTop.style.display = 'none';
    btns.classList.add('center');
    const restartCentered = makeButton('Restart', 'restart', () => restart());
    restartCentered.style.flex = '0 0 auto';
    btns.appendChild(restartCentered);
  } else {
    restartTop.style.display = 'inline-block';
    btns.classList.remove('center');
    if (node.type === 'question') {
      btns.appendChild(makeButton('Yes', 'yes', () => goToNode(node.yes)));
      btns.appendChild(makeButton('No', 'no', () => goToNode(node.no)));
    } else if (node.type === 'info') {
      btns.appendChild(makeButton('Next', 'next', () => goToNode(node.next)));
    }
  }

  // record last node for intro→IF flash logic
  lastNodeId = node.id;
}

/* ---------- Examples + Viz (Q15/Q17 special) ---------- */
function setupAuxToggles(node) {
  const wrap = document.getElementById('examplesToggleWrapper');
  const panel = document.getElementById('sharedPanel');

  wrap.innerHTML = '';
  collapseSharedPanel();
  panel.innerHTML = '';

  if (node.type !== 'question') return;

  const isSpecial = node.id === 'Q15' || node.id === 'Q17';

  const examplesBtn = document.createElement('button');
  examplesBtn.textContent = 'Show examples';
  examplesBtn.className = 'examples-btn';
  examplesBtn.setAttribute('aria-expanded', 'false');
  wrap.appendChild(examplesBtn);

  let vizBtn = null;
  if (isSpecial) {
    vizBtn = document.createElement('button');
    vizBtn.textContent = 'Show visualization';
    vizBtn.className = 'viz-btn';
    vizBtn.setAttribute('aria-expanded', 'false');
    wrap.appendChild(vizBtn);
  }

  examplesBtn.onclick = () => {
    const isOpenExamples = panel.style.display === 'block' && panel.dataset.mode === 'examples';
    if (isOpenExamples) {
      collapseSharedPanel();
      examplesBtn.setAttribute('aria-expanded','false');
      examplesBtn.classList.remove('active');
    } else {
      renderExamples(panel, node.id);
      openSharedPanel(panel, 'examples');
      examplesBtn.setAttribute('aria-expanded','true');
      examplesBtn.classList.add('active');
      if (vizBtn) { vizBtn.setAttribute('aria-expanded','false'); vizBtn.classList.remove('active'); }
    }
  };

  if (isSpecial && vizBtn) {
    vizBtn.onclick = () => {
      const isOpenViz = panel.style.display === 'block' && panel.dataset.mode === 'viz';
      const src = node.id === 'Q15' ? 'diminishing_returns_curve.png' : 'inverted_u_curve.png';
      const alt = node.id === 'Q15'
        ? 'Diminishing Returns Curve: Effort/Resources vs Functional Results'
        : 'Inverted-U Curve: Effort/Resources vs Functional Results';
      if (isOpenViz) {
        collapseSharedPanel();
        vizBtn.setAttribute('aria-expanded','false');
        vizBtn.classList.remove('active');
      } else {
        renderViz(panel, src, alt);
        openSharedPanel(panel, 'viz');
        vizBtn.setAttribute('aria-expanded','true');
        vizBtn.classList.add('active');
        examplesBtn.setAttribute('aria-expanded','false');
        examplesBtn.classList.remove('active');
      }
    };
  }
}
function renderExamples(panel, nodeId) {
  panel.innerHTML = '';
  const two = examples[nodeId] || ["Example 1: [edit me]","Example 2: [edit me]"];
  two.forEach(line => {
    const p = document.createElement('p');
    p.textContent = line;
    panel.appendChild(p);
  });
}
function renderViz(panel, src, alt) {
  panel.innerHTML = '';
  const img = document.createElement('img'); img.src = src; img.alt = alt;
  panel.appendChild(img);
}
function collapseSharedPanel() {
  const panel = document.getElementById('sharedPanel');
  panel.style.display = 'none';
  panel.setAttribute('aria-hidden','true');
  panel.dataset.mode = '';
  const wrap = document.getElementById('examplesToggleWrapper');
  wrap.querySelectorAll('button').forEach(btn => {
    const label = btn.classList.contains('viz-btn') ? 'Show visualization' : 'Show examples';
    btn.textContent = label; btn.setAttribute('aria-expanded','false'); btn.classList.remove('active');
  });
}
function openSharedPanel(panel, mode) {
  panel.style.display = 'block';
  panel.setAttribute('aria-hidden','false');
  panel.dataset.mode = mode;
  const wrap = document.getElementById('examplesToggleWrapper');
  const exBtn = wrap.querySelector('.examples-btn');
  const vzBtn = wrap.querySelector('.viz-btn');
  if (mode === 'examples') { if (exBtn) exBtn.textContent = 'Hide examples'; if (vzBtn) vzBtn.textContent = 'Show visualization'; }
  if (mode === 'viz') { if (vzBtn) vzBtn.textContent = 'Hide visualization'; if (exBtn) exBtn.textContent = 'Show examples'; }
}

/* ---------- Q26: centered number + slider (ticks), default severity=1 ---------- */
function showOrHideRiskInline(node) {
  const container = document.getElementById('riskInline');
  container.innerHTML = '';
  if (!node || node.id !== 'Q26') {
    container.style.display = 'none';
    container.setAttribute('aria-hidden','true');
    return;
  }
  container.style.display = 'block';
  container.setAttribute('aria-hidden','false');

  // Big centered number
  const sevDisplay = document.createElement('div');
  sevDisplay.className = 'sev-display';
  sevDisplay.id = 'sevDisplay';
  sevDisplay.textContent = '1';
  container.appendChild(sevDisplay);

  // Slider with tick marks via datalist
  const row = document.createElement('div'); row.className = 'risk-row';
  const slider = document.createElement('input');
  slider.type = 'range'; slider.min = '1'; slider.max = '10'; slider.step = '1';
  slider.setAttribute('list','riskTicks');
  slider.value = '1'; // always default to 1

  function applyFromSeverity(sev) {
    const thr = 100 - sev * 10;  // linear mapping
    currentThresholdPct = thr;   // sev=1 → 90
    sevDisplay.textContent = String(sev);
  }
  applyFromSeverity(1);
  slider.oninput = () => applyFromSeverity(parseInt(slider.value, 10));

  row.appendChild(slider);
  container.appendChild(row);

  // Ticks (1..10)
  const ticks = document.createElement('datalist');
  ticks.id = 'riskTicks';
  for (let i=1;i<=10;i++){ const opt=document.createElement('option'); opt.value=String(i); ticks.appendChild(opt); }
  container.appendChild(ticks);
}

/* ---------- Reasoning panel (chart on R8/R9; button near text) ---------- */
function setupReasoning(node) {
  const wrap = document.getElementById('reasoningToggleWrapper');
  const panel = document.getElementById('reasoningPanel');
  wrap.innerHTML = ''; panel.innerHTML = ''; panel.style.display='none'; panel.setAttribute('aria-hidden','true');

  if (node.id !== 'R8' && node.id !== 'R9') return;

  const btn = document.createElement('button');
  btn.textContent = 'Show percentage reasoning';
  btn.className = 'reasoning-btn';
  btn.setAttribute('aria-expanded','false');
  btn.onclick = () => {
    const open = panel.style.display === 'block';
    if (open) { panel.style.display='none'; panel.setAttribute('aria-hidden','true'); btn.textContent='Show percentage reasoning'; btn.setAttribute('aria-expanded','false'); }
    else { panel.style.display='block'; panel.setAttribute('aria-hidden','false'); btn.textContent='Hide percentage reasoning'; btn.setAttribute('aria-expanded','true'); }
  };
  wrap.appendChild(btn);

  const p = document.createElement('p');
  p.textContent = `Your current threshold is ${currentThresholdPct}%.`;
  panel.appendChild(p);

  const img = document.createElement('img');
  img.src = 'linear_threshold_chart.png';
  img.alt = 'Linear Severity to Action Threshold: Threshold = 100% − (Severity × 10%)';
  panel.appendChild(img);
}
function collapseReasoningPanel() {
  const panel = document.getElementById('reasoningPanel');
  if (!panel) return;
  panel.style.display='none'; panel.setAttribute('aria-hidden','true');
  const btn = document.getElementById('reasoningToggleWrapper').querySelector('button');
  if (btn) { btn.textContent='Show percentage reasoning'; btn.setAttribute('aria-expanded','false'); }
}

/* ---------- Nav ---------- */
function makeButton(label, cls, action) {
  const btn = document.createElement('button');
  btn.textContent = label; btn.className = cls; btn.onclick = action; return btn;
}
function goToNode(id) {
  const next = flowchart.find(n => n.id === id);
  historyStack.push(currentNode ? currentNode.id : '');
  currentNode = next; renderNode(currentNode);
}
function goBack() {
  const prevId = historyStack.pop();
  const prev = flowchart.find(n => n.id === prevId);
  currentNode = prev || currentNode; renderNode(currentNode);
}
function restart() {
  historyStack = [];
  currentSegment = "If You Should Act";
  lastNodeId = "Q0";
  currentNode = flowchart.find(n => n.id === "Q0");
  renderNode(currentNode);
}

/* ---------- Skip button: jump to Q24 ---------- */
document.getElementById('skipBtn').addEventListener('click', () => {
  goToNode('Q24');
});

/* ---------- Initial render ---------- */
renderNode(currentNode);
</script>
</body>
</html>
