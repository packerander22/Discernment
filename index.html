<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Discernment Flow Chart</title>
<style>
  body { font-family: Arial, sans-serif; background: #f7f7f7; margin: 0; padding: 0; }
  .container { max-width: 650px; margin: auto; padding: 20px; }
  .top-bar { display: flex; justify-content: space-between; margin-bottom: 10px; }
  .card {
    background: white; padding: 20px; border-radius: 8px;
    box-shadow: 0 2px 6px rgba(0,0,0,0.1); min-height: 260px;
    display: flex; flex-direction: column; justify-content: space-between;
  }
  .segment-heading {
    font-size: 1.4em; font-weight: bold; margin-bottom: 15px; padding: 8px;
    border-bottom: 2px solid #ddd; display: flex; align-items: center; gap: 8px;
    transition: background-color 0.5s ease, color 0.5s ease;
  }
  .flash-gold { background-color: gold !important; color: white !important; }
  .text { font-size: 1.2em; margin-bottom: 12px; white-space: pre-wrap; }
  .viz-toggle { margin: 8px 0 16px 0; }
  .viz-panel { display: none; border: 1px solid #eee; border-radius: 6px; padding: 10px; background: #fafafa; }
  .viz-panel img { width: 100%; height: auto; display: block; }
  .buttons { display: flex; gap: 10px; flex-wrap: wrap; }
  button {
    flex: 1; padding: 10px; font-size: 1em; border: none; border-radius: 5px; cursor: pointer;
  }
  button.yes { background: #4CAF50; color: white; }
  button.no { background: #F44336; color: white; }
  button.next { background: #2196F3; color: white; }
  button.back { background: #9E9E9E; color: white; flex: 0 0 auto; }
  button.restart { background: #9C27B0; color: white; flex: 0 0 auto; }
  button.viz-btn { background: #555; color: white; flex: 0 0 auto; }
</style>
</head>
<body>
<div class="container">
  <div class="top-bar">
    <button class="back" id="backBtn" onclick="goBack()">Back</button>
    <button class="restart" onclick="restart()">Restart</button>
  </div>

  <div class="card">
    <div id="segmentHeading" class="segment-heading"></div>

    <div>
      <div id="text" class="text"></div>

      <!-- Visualization toggle area (only appears on Q16/Q19) -->
      <div id="vizToggleWrapper" class="viz-toggle"></div>
      <div id="vizPanel" class="viz-panel">
        <img id="vizImage" alt="Visualization">
      </div>
    </div>

    <div id="buttons" class="buttons"></div>
  </div>
</div>

<script>
// ==== Corrected JSON flow ====
const flowchart = [
  { "id": "Q1", "type": "question", "text": "Are there any other more important things to do or think about right now?", "yes": "R1", "no": "Q2" },
  { "id": "Q2", "type": "question", "text": "Is there a known problem or potential QoL change that involves your needs and wants of a subject not being met functionally?", "yes": "Q6", "no": "Q3" },
  { "id": "Q3", "type": "question", "text": "Is there cause for a potential problem that would directly affect your needs and wants of a subject not being met functionally?", "yes": "Q6", "no": "Q4" },
  { "id": "Q4", "type": "question", "text": "Is there cause for a POTENTIAL cause for a POTENTIAL problem that would directly affect your needs and wants of a subject not being met functionally?", "yes": "Q6", "no": "R2" },
  { "id": "Q6", "type": "question", "text": "Is there a solution to the problem/potential problem even if it’s currently unavailable (or a means of bringing about the QoL change)?", "yes": "Q7", "no": "R3" },
  { "id": "Q7", "type": "question", "text": "Can this solution or QoL change be brought about by your influence?", "yes": "Q10", "no": "Q8" },
  { "id": "Q8", "type": "question", "text": "Do everything in your power first to achieve the desired result, but know that past that it’s out of your hands, and worrying and obsessing won’t change anything and is unhealthy. Is there anything further you can do?", "yes": "Q10", "no": "Q9" },
  { "id": "Q9", "type": "question", "text": "Is there an alternative solution that would solve the problem (or improve QoL) in a way that’s within your control or in a better overall way?", "yes": "R4", "no": "R2" },
  { "id": "Q10", "type": "question", "text": "Does this solution or QoL change involve gaining information that would be valuable in the future?", "yes": "Q11", "no": "Q12" },
  { "id": "Q11", "type": "question", "text": "Would the information alone gained from doing this outweigh the downsides it would likely cause to make this happen?", "yes": "Q27", "no": "Q12" },
  { "id": "Q12", "type": "question", "text": "Is it worth your resources to solve it?", "yes": "Q14", "no": "Q13" },
  { "id": "Q13", "type": "question", "text": "Is there an alternative solution that would solve the problem (or improve QoL) in a way that’s worth it to you or in a better overall way?", "yes": "R4", "no": "R2" },
  { "id": "Q14", "type": "question", "text": "Would the benefits of addressing this issue outweigh any downsides it might likely cause?", "yes": "Q16", "no": "Q15" },
  { "id": "Q15", "type": "question", "text": "Is there an alternative solution that would solve the problem (or improve QoL) in a way that’s worth it to you or in a better overall way?", "yes": "R4", "no": "R2" },
  { "id": "Q16", "type": "question", "text": "Does addressing this issue involve a diminishing returns curve for effort applied?", "yes": "Q17", "no": "Q19" },
  { "id": "Q17", "type": "info", "text": "Do your best to find the point of diminishing returns, then only act until that point. Have the courage to stop there. If you are prone to getting sucked into a particular activity (addressing a problem or QoL change), think of an alternative approach that also solves the problem (or improves QoL) in a different way without the addictive aspect. If a better approach is not available for whatever reason, the original approach can be used only if you pre-allocate a set time limit for yourself beforehand and make some follow through commitments, maybe with a reward for stopping that you would be excited about.", "next": "Q19" },
  { "id": "Q19", "type": "question", "text": "Does addressing this issue directly involve an inverted-U curve for specific effort applied with an objective sweet spot where clear information is available to you?", "yes": "Q20", "no": "Q21" },
  { "id": "Q20", "type": "info", "text": "Wait until there aren’t any other more important things to do, then if it’s worth it to you, find that sweet spot. If not, put in as much effort as you deem worth it.", "next": "Q27" },
  { "id": "Q21", "type": "question", "text": "In practice, would a worthwhile functional difference likely be noticed if the problem/potential problem/QoL change was solved/prevented/changed (for example in a blind test compared side by side, and ignoring any differences irrelevant to the actual functionality of the intended purpose associated)?", "yes": "Q22", "no": "R2" },
  { "id": "Q22", "type": "question", "text": "Would solving/preventing it help get rid of/prevent the problem (or improve QoL) in the long term?", "yes": "Q27", "no": "Q23" },
  { "id": "Q23", "type": "question", "text": "Would solving/preventing it help get rid of/prevent the problem (or improve QoL) in the short term?", "yes": "Q24", "no": "R2" },
  { "id": "Q24", "type": "question", "text": "Is it logically worth solving/preventing EVERY time? (Or this time knowing it’s temporary?)", "yes": "Q27", "no": "Q26" },
  { "id": "Q26", "type": "question", "text": "Is there an alternative solution that would solve the problem (or improve QoL), in the long term or in a better overall way?", "yes": "R4", "no": "R2" },

  { "id": "Q27", "type": "question", "text": "Does this address a current problem or potential QoL change?", "yes": "Q31", "no": "Q29" },
  { "id": "Q29", "type": "question", "text": "Does addressing this issue involve preventative maintenance?", "yes": "Q30", "no": "Q31" },
  { "id": "Q30", "type": "question", "text": "Would there be clear telltale signs of future functional failure before it actually happened, with a big enough window of time to address it properly in advance?", "yes": "Q33", "no": "Q32" },
  { "id": "Q31", "type": "question", "text": "Is this the best solution you know of assuming you could do it now?", "yes": "Q36", "no": "Q34" },
  { "id": "Q32", "type": "result", "text": "Wait until the expected downsides of not acting now outweigh the downsides of acting now, AND the estimated chance that current functional failure is nearing or greater than 50%, then solve/address it. Consider any ways to reduce the downsides and/or the likelihood of it failing." },
  { "id": "Q33", "type": "result", "text": "Wait until those signs are indicated, the expected downsides of not acting now outweigh the downsides of acting now, AND the estimated chance that current functional failure is nearing or greater than 50%, then solve/address it. Consider any ways to reduce the downsides and/or the likelihood of it failing." },
  { "id": "Q34", "type": "question", "text": "Have you considered all better solutions you know of?", "yes": "Q36", "no": "Q35" },
  { "id": "Q35", "type": "info", "text": "Consider them.", "next": "R4" },
  { "id": "Q36", "type": "question", "text": "Is this solution currently available?", "yes": "Q40_available", "no": "Q37" },
  { "id": "Q37", "type": "question", "text": "Is there a better time down the road to solve/address this to maximize value?", "yes": "Q38", "no": "R6" },
  { "id": "Q38", "type": "question", "text": "Assuming you waited until it was available, would the benefits of using this solution outweigh the downsides of having to wait?", "yes": "Q40_unavailable", "no": "Q39" },
  { "id": "Q39", "type": "question", "text": "Is there a next best solution?", "yes": "R4", "no": "R3" },
  { "id": "Q40_available", "type": "question", "text": "Is there a better time further down the road than when this solution is available to solve/address this to maximize value?", "yes": "R7", "no": "R6" },
  { "id": "Q40_unavailable", "type": "question", "text": "Is there a better time further down the road than when this solution is available to solve/address this to maximize value?", "yes": "R7", "no": "R5" },

  { "id": "R1", "type": "result", "text": "Worry about it once the time is right." },
  { "id": "R2", "type": "result", "text": "Don’t worry about it." },
  { "id": "R3", "type": "result", "text": "Wait until there aren’t any other more important things to do, then if it’s worth it to you, find a solution or solutions. If not, put in as much effort as you deem worth it." },
  { "id": "R4", "type": "result", "text": "Consider any other solutions, from best to worst, if you haven’t already. Run them through the chart." },
  { "id": "R5", "type": "result", "text": "Wait until the best solution given the circumstances is available, then solve it once there aren’t any other more important things to do." },
  { "id": "R6", "type": "result", "text": "Address it sooner than later, once there aren’t any other more important things to do." },
  { "id": "R7", "type": "result", "text": "Wait until that time, then solve/address it. Consider any other options that could also work and be worth it until then." }
]
;

// Nodes that begin the "When You Should Act" section
const whenSectionStarts = ["Q27", "Q29", "Q30", "Q31"];

// Visualization mapping for specific question IDs
const visualizations = {
  Q16: {
    src: "diminishing_returns_curve_final.png",
    alt: "Diminishing Returns Curve: Effort/Resources vs Functional Results"
  },
  Q19: {
    src: "inverted_u_curve.png",
    alt: "Inverted-U Curve: Effort/Resources vs Functional Results"
  }
};

let historyStack = [];
let currentNode = flowchart.find(n => n.id === "Q1");
let currentSegment = "If You Should Act"; // default at start

function getSegmentForNodeId(id) {
  return whenSectionStarts.includes(id) ? "When You Should Act" : "If You Should Act";
}

function flashHeading() {
  const headingDiv = document.getElementById('segmentHeading');
  headingDiv.classList.add('flash-gold');
  setTimeout(() => headingDiv.classList.remove('flash-gold'), 1500);
}

function getSegmentIcon(segment) {
  return segment === "If You Should Act" ? "✅" : "⏳";
}

function renderNode(node) {
  // Segment handling based on the node we just navigated to
  const thisSegment = getSegmentForNodeId(node.id);
  if (thisSegment !== currentSegment) {
    currentSegment = thisSegment;
    flashHeading();
  }
  document.getElementById('segmentHeading').textContent =
    `${getSegmentIcon(currentSegment)} ${currentSegment}`;

  // Text
  document.getElementById('text').textContent = node.text || '';

  // Back visibility
  document.getElementById('backBtn').style.visibility =
    historyStack.length > 0 ? 'visible' : 'hidden';

  // Show/hide visualization UI
  setupVisualization(node);

  // Bottom buttons
  const btns = document.getElementById('buttons');
  btns.innerHTML = '';
  if (node.type === 'question') {
    btns.appendChild(makeButton('Yes', 'yes', () => goToNode(node.yes)));
    btns.appendChild(makeButton('No', 'no', () => goToNode(node.no)));
  } else if (node.type === 'info') {
    btns.appendChild(makeButton('Next', 'next', () => goToNode(node.next)));
  } else if (node.type === 'result') {
    // No local nav buttons; use Back/Restart on top bar
  }
}

function setupVisualization(node) {
  const toggleWrap = document.getElementById('vizToggleWrapper');
  const panel = document.getElementById('vizPanel');
  const img = document.getElementById('vizImage');

  // Reset
  toggleWrap.innerHTML = '';
  panel.style.display = 'none';
  img.removeAttribute('src');
  img.removeAttribute('alt');

  // Only attach for Q16 (diminishing returns) and Q19 (inverted-U)
  const viz = visualizations[node.id];
  if (!viz) return;

  // Build the "Show visualization" toggle button
  const btn = document.createElement('button');
  btn.textContent = 'Show visualization';
  btn.className = 'viz-btn';
  btn.setAttribute('aria-expanded', 'false');

  btn.onclick = () => {
    const isOpen = panel.style.display === 'block';
    if (isOpen) {
      panel.style.display = 'none';
      btn.textContent = 'Show visualization';
      btn.setAttribute('aria-expanded', 'false');
    } else {
      // Lazy-load the image the first time
      if (!img.getAttribute('src')) {
        img.src = viz.src;
        img.alt = viz.alt;
      }
      panel.style.display = 'block';
      btn.textContent = 'Hide visualization';
      btn.setAttribute('aria-expanded', 'true');
    }
  };

  toggleWrap.appendChild(btn);
}

function makeButton(label, cls, action) {
  const btn = document.createElement('button');
  btn.textContent = label;
  btn.className = cls;
  btn.onclick = action;
  return btn;
}

function goToNode(id) {
  historyStack.push(currentNode.id);
  currentNode = flowchart.find(n
