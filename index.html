<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Discernment Guide</title>

<!-- Favicon set -->
<link rel="icon" type="image/svg+xml" href="favicon.svg">
<link rel="icon" type="image/png" sizes="16x16" href="favicon_16.png">
<link rel="icon" type="image/png" sizes="32x32" href="favicon_32.png">
<link rel="icon" type="image/png" sizes="48x48" href="favicon_48.png">
<link rel="icon" type="image/png" sizes="64x64" href="favicon_64.png">
<link rel="apple-touch-icon" sizes="180x180" href="favicon_180.png">
<link rel="icon" type="image/png" sizes="192x192" href="favicon_192.png">
<link rel="icon" type="image/png" sizes="256x256" href="favicon_256.png">
<link rel="icon" type="image/png" sizes="384x384" href="favicon_384.png">
<link rel="icon" type="image/png" sizes="512x512" href="favicon_512.png">
<link rel="shortcut icon" href="favicon.ico">
<link rel="icon" type="image/png" href="favicon_512.png?v=2">

<style>
  :root {
    --btn-pad-y:10px; --btn-pad-x:12px;

    /* slider custom props */
    --track-height: 12px;
    --thumb-size: 28px;
    --thumb-shadow: 0 1px 3px rgba(0,0,0,.25);
    --track-bg: #e0e0e0; /* right side */
    --fill: #2d6cdf;     /* left side (updated via JS) */
    --pct: 0%;           /* fill percent (updated via JS) */
    --tick-color: rgba(0,0,0,.35);
    --tick-thickness: 2px;
    --tick-length: 6px;
  }

  body { font-family: Arial, sans-serif; background:#f7f7f7; margin:0; padding:0; }
  .container { max-width: 650px; margin:auto; padding:20px; }
  .top-bar { display:flex; justify-content:space-between; margin-bottom:10px; }
  .card {
    background:#fff; padding:20px; border-radius:8px;
    box-shadow:0 2px 6px rgba(0,0,0,0.1); min-height:280px;
    display:flex; flex-direction:column; justify-content:space-between;
  }

  /* Header */
  .segment-heading {
    display:flex; align-items:center; justify-content:space-between;
    font-size:1.8em; font-weight:bold; margin-bottom:15px; padding:8px;
    border-bottom:2px solid #ddd; gap:12px; transition: color .5s ease;
  }
  .segment-title { display:inline-flex; align-items:center; gap:8px; }
  .segment-title img.logo { height:1.2em; width:auto; vertical-align:middle; margin-right:6px; }
  .flash-gold { color: goldenrod !important; }
  .flash-green { color: #2e7d32 !important; }

  /* Buttons */
  button { flex:1; padding:var(--btn-pad-y) var(--btn-pad-x); font-size:1em; border:none; border-radius:5px; cursor:pointer; }
  button.yes { background:#4CAF50; color:#fff; }
  button.no { background:#F44336; color:#fff; }
  button.same { background:#1E88E5; color:#fff; }
  button.next { background:#2196F3; color:#fff; }
  button.back { background:#555; color:#fff; flex:0 0 auto; }
  button.restart { background:#9C27B0; color:#fff; flex:0 0 auto; }
  button.examples-btn, button.viz-btn, button.reasoning-btn { background:#9E9E9E; color:#fff; }
  .ctrl-btn { flex:1; }
  button.active { outline:2px solid #000; }

  .segment-heading .skip-btn {
    display:inline-flex; align-items:center; justify-content:center;
    flex:0 0 auto; padding:var(--btn-pad-y) var(--btn-pad-x);
    font-size:1rem; line-height:1; border:none; border-radius:5px; cursor:pointer;
    background:#e9e9e9; color:#333;
  }
  .segment-heading .skip-btn:hover { background:#dedede; }

  .text { font-size:1.3em; margin-bottom:12px; white-space:pre-wrap; }

  .controls-row { display:flex; gap:10px; margin:6px 0 18px 0; }
  .left-controls, .right-controls { flex:1; display:flex; gap:10px; }

  .panel {
    display:none; border:1px solid #eee; border-radius:6px; padding:10px; background:#fafafa;
    margin-bottom:18px;
  }
  .panel p { margin:6px 0; }
  .panel img { width:100%; height:auto; display:block; }

  .buttons { display:flex; gap:10px; flex-wrap:wrap; justify-content:flex-start; }
  .buttons.center { justify-content:center; }

  /* Slider container */
  .risk-inline { display:none; border:1px solid #eee; border-radius:6px; padding:12px; background:#fafafa; margin:8px 0 18px 0; }
  .sev-display { text-align:center; font-size:1.8em; font-weight:bold; margin-bottom:8px; }
  .risk-row { display:flex; align-items:center; gap:10px; margin:0; }
  .risk-row input[type="range"] { width:100%; }
  .risk-ticks { display:block; width:100%; }

  .error { color:#B00020; font-size:0.95em; }

  /* === Slider visual customization (bigger, aligned, left-side heat fill) === */
  .slider-wrap {
    position: relative;
    width: 100%;
    height: calc(var(--thumb-size) + var(--tick-length) * 2 + 8px);
    display: flex;
    align-items: center; /* keeps thumb vertically aligned */
    justify-content: center;
  }

  .heat-slider {
    -webkit-appearance: none;
    appearance: none;
    width: 100%;
    height: var(--thumb-size);
    background: transparent;
    position: relative;
    z-index: 1; /* above tick rows */
  }

  /* WebKit track: left solid heat color, right neutral */
  .heat-slider::-webkit-slider-runnable-track {
    height: var(--track-height);
    border-radius: calc(var(--track-height) / 2);
    background:
      linear-gradient(to right,
        var(--fill) 0%,
        var(--fill) var(--pct),
        var(--track-bg) var(--pct),
        var(--track-bg) 100%);
  }
  /* WebKit thumb: centered via negative margin */
  .heat-slider::-webkit-slider-thumb {
    -webkit-appearance: none;
    appearance: none;
    width: var(--thumb-size);
    height: var(--thumb-size);
    border-radius: 50%;
    background: #fff;
    border: 2px solid #999;
    box-shadow: var(--thumb-shadow);
    margin-top: calc((var(--thumb-size) - var(--track-height)) / -2);
    cursor: pointer;
  }

  /* Tick rows (outside the track), inset to match THUMB TRAVEL (half-thumb each side) */
  .tick-row {
    position: absolute;
    left: calc(var(--thumb-size) / 2);
    right: calc(var(--thumb-size) / 2);
    height: var(--tick-length);
    pointer-events: none;
    z-index: 0; /* under slider */
  }
  /* Touch the track edge (tiny 1px overlap to avoid a hairline seam) */
  .tick-row.top {
    bottom: calc(50% + var(--track-height)/2 - 1px);
  }
  .tick-row.bottom {
    top: calc(50% + var(--track-height)/2 - 1px);
  }
  .tick {
    position: absolute;
    width: var(--tick-thickness);
    height: 100%;
    background: var(--tick-color);
    transform: translateX(-50%); /* center the 2px bar on its position */
  }

  /* Firefox */
  .heat-slider::-moz-range-track {
    height: var(--track-height);
    border-radius: calc(var(--track-height) / 2);
    background: var(--track-bg);
  }
  .heat-slider::-moz-range-progress {
    height: var(--track-height);
    border-radius: calc(var(--track-height) / 2);
    background: var(--fill);
  }
  .heat-slider::-moz-range-thumb {
    width: var(--thumb-size);
    height: var(--thumb-size);
    border-radius: 50%;
    background: #fff;
    border: 2px solid #999;
    box-shadow: var(--thumb-shadow);
    cursor: pointer;
  }

  /* Edge/IE (best-effort) */
  .heat-slider::-ms-track {
    height: var(--track-height);
    border-color: transparent;
    color: transparent;
    background: transparent;
  }
  .heat-slider::-ms-fill-lower { background: var(--fill); border-radius: calc(var(--track-height)/2); }
  .heat-slider::-ms-fill-upper { background: var(--track-height); border-radius: calc(var(--track-height)/2); }
  .heat-slider::-ms-thumb {
    width: var(--thumb-size); height: var(--thumb-size);
    border-radius: 50%; background: #fff; border:2px solid #999; box-shadow: var(--thumb-shadow);
  }
</style>
</head>
<body>
<div class="container">
  <div class="top-bar">
    <button class="back" id="backBtn" onclick="goBack()">Back</button>
    <button class="restart" id="restartTop" onclick="restart()">Restart</button>
  </div>

  <div class="card">
    <div id="segmentHeading" class="segment-heading">
      <span id="segmentTitle" class="segment-title"></span>
      <button id="skipBtn" class="skip-btn" style="display:none;" title="Skip to when you should act">Skip ⏭</button>
    </div>

    <div>
      <div id="text" class="text"></div>

      <div class="controls-row">
        <div id="leftControlsWrapper" class="left-controls"></div>
        <div id="rightControlsWrapper" class="right-controls"></div>
      </div>

      <div id="sharedPanel" class="panel" aria-hidden="true"></div>
      <div id="riskInline" class="risk-inline" aria-hidden="true"></div>
      <div id="reasoningPanel" class="panel" aria-hidden="true"></div>

      <div id="errorBox" class="error"></div>
    </div>

    <div id="buttons" class="buttons"></div>
  </div>
</div>

<script>
/* =========================
   Renumbering map note:
   Inserted NEW Q38 (from Q37 "same") and shifted Q39+.
   Results reindexed so:
   R30→R3, old R3→R4, R4→R5, R5→R6, R6→R7, R7→R8, R8→R9
========================= */

// ======= FLOW (Q0–Q44) =======
var flowchart = [
  { "id": "Q0",  "type": "info",     "text": "Welcome! This flow chart guide helps you determine both <i>IF</i> and <i>WHEN</i> you should act on an issue. This will help to avoid wasting resources and time, and getting stuck in <i>analysis paralysis</i>.\nYou’ll answer simple Yes/No questions (and a slider later). Tap Next to begin.", "next": "Q1" },

  /* ===== IF YOU SHOULD ACT ===== */
  { "id": "Q1",  "type": "question", "text": "Are there any other more important things to do or think about right now?", "yes": "R1",  "no": "Q2" },
  { "id": "Q2",  "type": "question", "text": "Is there a current <i>real problem</i> or desired functional QoL (quality of life) improvement, rather than just a <i>“problem”</i> or preference that doesn’t affect performance or outcomes?", "yes": "Q8",  "no": "Q3" },
  { "id": "Q3",  "type": "question", "text": "Is there cause for a potential <i>real problem</i>, rather than just a <i>“problem”</i> that doesn’t affect performance or outcomes?", "yes": "Q5",  "no": "Q4" },
  { "id": "Q4",  "type": "question", "text": "Is there cause for a POTENTIAL cause for a POTENTIAL <i>real problem</i>, rather than just a <i>“problem”</i> that doesn’t affect performance or outcomes?", "yes": "Q8",  "no": "R2" },

  { "id": "Q5",  "type": "question", "text": "Is the potential problem inevitable if left unaddressed?", "yes": "Q8",  "no": "Q6" },
  { "id": "Q6",  "type": "question", "text": "Would the expected downsides of <i>NOT addressing this issue</i> outweigh the downsides <i>OF addressing this issue</i>?", "yes": "Q8",  "no": "Q16", "same": "Q7" },
  { "id": "Q7",  "type": "question", "text": "Is the problem more likely to occur than not if left unaddressed?", "yes": "Q8",  "no": "Q16" },

  { "id": "Q8",  "type": "question", "text": "Is there a solution (or at least partial solution) to the problem/potential problem even if it’s currently unavailable (or a means of bringing about the QoL improvement)?", "yes": "Q9",  "no": "R4" },
  { "id": "Q9",  "type": "question", "text": "Can this solution or QoL improvement be <i>guaranteed</i> by <i>your</i> influence?", "yes": "Q12", "no": "Q10" },
  { "id": "Q10", "type": "question", "text": "Do everything in your power first to achieve the desired result, but know that past that it’s out of your hands, and <i>worrying and obsessing won’t change anything and is unhealthy</i>. Is there anything further you can do?", "yes": "Q12", "no": "Q11" },
  { "id": "Q11", "type": "question", "text": "Is there an alternative solution that would solve the problem (or improve QoL) in a way that’s within your control or in a <i>better overall way</i>?", "yes": "R5",  "no": "R2" },

  { "id": "Q12", "type": "question", "text": "Does this solution or QoL improvement involve gaining information that would be <i>valuable in the future</i>?", "yes": "Q13", "no": "Q14" },
  { "id": "Q13", "type": "question", "text": "Would the <i>information alone</i> gained from doing this outweigh the downsides it would likely cause to make this happen?", "yes": "Q27", "no": "Q14" },

  { "id": "Q14", "type": "question", "text": "Would the <i>benefits</i> of addressing this issue outweigh any <i>downsides</i> it might likely cause?", "yes": "Q18", "no": "Q16", "same": "Q15" },
  { "id": "Q15", "type": "question", "text": "All things considered and despite the downsides involved, would you rather address it than not?", "yes": "Q18", "no": "Q16" },
  { "id": "Q16", "type": "question", "text": "Is there a time further down the road that the answer to the <i>previous question</i> could be yes?", "yes": "R3", "no": "Q17" },
  { "id": "Q17", "type": "question", "text": "Is there an alternative solution that would solve the problem (or improve QoL) in a way that’s worth it or in a <i>better overall way</i>?", "yes": "R5",  "no": "R2" },

  { "id": "Q18", "type": "question", "text": "Does addressing this issue involve a <i>diminishing returns</i> curve for effort applied?", "yes": "Q19", "no": "Q20" },
  { "id": "Q19", "type": "info",     "text": "Find the <i>point of diminishing returns</i> and stop there. If you tend to get absorbed in an activity, find an alternative approach that solves the problem or improves QoL <i>without the addictive pull</i> and possibly even in a <i>better overall way</i>. Treat this approach as a \"better,\" more effective overall solution. If it's not available, you may use the original approach if needed—but <i>only</i> with a pre-set time limit and timer, after which you must stop and re-evaluate.", "next": "Q20" },
  { "id": "Q20", "type": "question", "text": "Does addressing this issue directly involve an <i>inverted-U curve</i> for specific effort applied with an <i>objective sweet spot</i> where clear information is available to you?", "yes": "Q21", "no": "Q22" },
  { "id": "Q21", "type": "info",     "text": "Wait until there aren’t any other more important things to do, then if it’s worth it to you, find that <i>sweet spot</i>. If not, put in as much effort as you deem worth it.", "next": "Q27" },

  { "id": "Q22", "type": "question", "text": "In practice and given time, would a <i>worthwhile functional difference</i> likely be noticed if the issue was solved/addressed?", "yes": "Q23", "no": "R2" },
  { "id": "Q23", "type": "question", "text": "Would solving/addressing it help get rid of/prevent the problem (or improve QoL) in the <i>long term</i>?", "yes": "Q27", "no": "Q24" },
  { "id": "Q24", "type": "question", "text": "Would solving/addressing it help get rid of/prevent the problem (or improve QoL) in the <i>short term</i>?", "yes": "Q25", "no": "R2" },
  { "id": "Q25", "type": "question", "text": "Is it logically worth solving/addressing <i>EVERY time</i>? (Or this time knowing it’s <i>temporary</i>?)", "yes": "Q27", "no": "Q26" },
  { "id": "Q26", "type": "question", "text": "Is there an alternative solution that would solve the problem (or improve QoL), in the long term or in a <i>better overall way</i>?", "yes": "R5",  "no": "R2" },

  /* ===== WHEN YOU SHOULD ACT ===== */
  { "id": "Q27", "type": "question", "text": "Does this address a potential <i>future</i> problem?", "yes": "Q28", "no": "Q31" },
  { "id": "Q28", "type": "question", "text": "Does addressing this issue involve <i>preventative maintenance</i>?", "yes": "Q33", "no": "Q31" },

  /* Severity selection */
  { "id": "Q29", "type": "info",     "text": "Set the estimated catastrophic severity if you waited too long to act. (1-10)", "next": "Q30" },
  { "id": "Q30", "type": "question", "text": "Would there be <i>guaranteed clear telltale signs</i> of future functional failure before it actually happened, with a big enough window of time to address it properly in advance?", "yes": "Q43", "no": "Q44" },

  /* Availability / timing */
  { "id": "Q31", "type": "question", "text": "Is this the <i>most effective solution</i> you know of (that meets the previous criteria), assuming you could do it <i>now</i>?", "yes": "Q35", "no": "Q32" },
  { "id": "Q32", "type": "question", "text": "Have you considered <i>all better solutions</i> you know of?", "yes": "Q35", "no": "R5" },

  { "id": "Q33", "type": "question", "text": "Is this the <i>most effective solution</i> you know of (that meets the previous criteria)?", "yes": "Q29", "no": "Q34" },
  { "id": "Q34", "type": "question", "text": "Have you considered <i>all better solutions</i> you know of?", "yes": "Q29", "no": "R5" },

  { "id": "Q35", "type": "question", "text": "Is this solution <i>currently</i> available?", "yes": "Q39", "no": "Q37" },
  { "id": "Q36", "type": "question", "text": "Is there a <i>better time</i> down the road to solve/address this to <i>maximize value</i>?", "yes": "Q37", "no": "R7" },

  /* Q37 with third path to NEW Q38 */
  { "id": "Q37", "type": "question", "text": "Assuming you waited until it was available, would the <i>benefits</i> of using this solution outweigh the <i>downsides</i> of having to wait?", "yes": "Q41", "no": "Q39", "same": "Q38" },

  /* NEW Q38 */
  { "id": "Q38", "type": "question", "text": "All things considered and despite the downsides of waiting, would you rather use this solution?", "yes": "Q41", "no": "Q39" },

  { "id": "Q39", "type": "question", "text": "Is there a <i>better</i> solution you know of?", "yes": "R5",  "no": "R4" },
  { "id": "Q40", "type": "question", "text": "Is there a <i>better time</i> further down the road to solve/address this to <i>maximize value</i>?", "yes": "R8",  "no": "R7" },
  { "id": "Q41", "type": "question", "text": "Is there a <i>better time</i> further down the road than when this solution is available to solve/address this to <i>maximize value</i>?", "yes": "R8",  "no": "R6" },
  { "id": "Q42", "type": "question", "text": "Is there a <i>better time</i> further down the road than at that time to solve/address this to <i>maximize value</i>?", "yes": "R8",  "no": "R6" },

  /* WHEN thresholds (shifted: old Q42→Q43, old Q43→Q44) */
  { "id": "Q43", "type": "question", "text": "Normally you should solve/address it as soon as both of the following are true: <ul><li><i>Those telltale signs</i> indicate that failure is approaching.</li><li>The <i>estimated chance of failure</i> is nearing or greater than 50%.</li></ul>\nHowever, is there a <i>better time</i> before or after that time to solve/address this to <i>maximize value</i>?", "yes": "R8", "no": "R9" },
  { "id": "Q44", "type": "question", "text": "Normally you should solve/address it as soon as the <i>estimated chance of failure</i> is nearing or greater than 50%.\nHowever, is there a <i>better time</i> before or after that time to solve/address this to <i>maximize value</i>?", "yes": "R8", "no": "R9" },

  /* RESULTS (renumbered) */
  { "id": "R1",  "type": "result",   "text": "Worry about this <i>once those things are addressed</i> and the time is right." },
  { "id": "R2",  "type": "result",   "text": "<i>Don’t worry about it:)</i>" },
  { "id": "R3",  "type": "result",   "text": "If that time ever does come, re-evaluate the issue. Until then, don't worry about it:)" },
  { "id": "R4",  "type": "result",   "text": "Wait until there aren’t any other more important things to do, then if it’s worth it to you, <i>find a solution or solutions</i>. If not, put in as much effort as you deem worth it." },
  { "id": "R5",  "type": "result",   "text": "Consider any other solutions, from best to worst, if you haven’t already. Run them through the chart." },
  { "id": "R6",  "type": "result",   "text": "Wait until the <i>best solution</i> given the circumstances is available, then solve it once there aren’t any other more important things to do." },
  { "id": "R7",  "type": "result",   "text": "Address it <i>sooner than later</i>, once there aren’t any other more important things to do." },
  { "id": "R8",  "type": "result",   "text": "Wait until that better time, then solve/address it once there aren't any other more important things to do. Consider any other options that could also work and be worth it until then." },
  { "id": "R9",  "type": "result",   "text": "Solve/address it as soon as the criteria from the <i>previous slide</i> (before the question) come true, once there aren’t any other more important things to do." }
];

/* ===== EXAMPLES (trimmed) ===== */
var examples = {/* same as before */};

/* ======= STATE ======= */
var currentThresholdPct = 90;
var q6WasYes = false;

/* ======= APP LOGIC ======= */
var historyStack = [];
var currentNode = flowchart.find(function(n){ return n.id === "Q0"; });
var currentSegment = "If You Should Act";

function getSegmentForNodeId(id) {
  if (!id || id.charAt(0) !== 'Q') return currentSegment;
  var m = /^Q(\d+)$/.exec(id);
  if (!m) return currentSegment;
  var num = parseInt(m[1], 10);
  return num >= 27 ? "When You Should Act" : "If You Should Act";
}

function setHeadingText(nodeId) {
  var title = document.getElementById('segmentTitle');
  var skipBtn = document.getElementById('skipBtn');

  if (nodeId === 'Q0') {
    title.innerHTML =
      "<img src='favicon_512.png' srcset='favicon_64.png 1x, favicon_256.png 2x, favicon_512.png 3x' alt='Discernment Logo' class='logo'>Discernment Guide";
    skipBtn.style.display = 'none';
    return;
  }

  title.textContent = (currentSegment === "If You Should Act") ? "⚖️ If You Should Act" : "⏳ When You Should Act";
  skipBtn.style.display = (currentSegment === "If You Should Act") ? 'inline-block' : 'none';
}

function flashHeadingColor(targetSegment) {
  if (currentNode && currentNode.id === 'Q0') return;
  var headingDiv = document.getElementById('segmentHeading');
  var cls = (targetSegment === "If You Should Act") ? 'flash-green' : 'flash-gold';
  headingDiv.classList.add(cls);
  setTimeout(function(){ headingDiv.classList.remove(cls); }, 1500);
}

/* Close panels when changing screens */
function closeAllPanels() {
  collapseSharedPanel();
  collapseReasoningPanel();
  var risk = document.getElementById('riskInline');
  if (risk) {
    risk.style.display = 'none';
    risk.setAttribute('aria-hidden','true');
  }
}

/* --- Q6 → Q14 auto-skip hook --- */
function beforeEnterNode(nextId) {
  if (nextId === 'Q14' && q6WasYes) {
    var nodeQ14 = flowchart.find(function(n){ return n.id === 'Q14'; });
    return (nodeQ14 && nodeQ14.yes) ? nodeQ14.yes : nextId;
  }
  return nextId;
}

/* ---------- Threshold transformers for Q43/Q44 ---------- */
function transformQ43(html) {
  if (currentThresholdPct <= 0) {
    var listBlockRe = /:\s*<ul>[\s\S]*?<\/ul>/i;
    return html.replace(listBlockRe, ' there is even a <i>SMALL</i> chance of failure.');
  }
  return html.replace(
    /(?:nearing\s+or\s+greater\s*than\s*)?50%/gi,
    'nearing or greater than ' + String(currentThresholdPct) + '%'
  );
}

function transformQ44(html) {
  if (currentThresholdPct <= 0) {
    var probClauseRe = /the\s*<i>estimated\s+chance\s+of\s+failure<\/i>\s+is\s+nearing\s+or\s+greater\s+than\s*50%/i;
    return html.replace(probClauseRe, 'there is even a <i>SMALL</i> chance of failure');
  }
  return html.replace(
    /(?:nearing\s+or\s+greater\s*than\s*)?50%/gi,
    'nearing or greater than ' + String(currentThresholdPct) + '%'
  );
}

/* ---------- Slider color helpers (aggressive red) ---------- */
function heatColorForSeverity(sev) {
  var ratio = Math.pow((sev - 1) / 9, 0.4); // push red earlier
  var hue = 220 * (1 - ratio);              // 220=blue → 0=red
  return 'hsl(' + Math.round(hue) + ', 100%, 50%)';
}
function updateSliderFill(slider, sev) {
  var pct = ((sev - 1) / 9) * 100; // 0..100 (ticks 1..10)
  slider.style.setProperty('--pct', pct + '%');
  slider.style.setProperty('--fill', heatColorForSeverity(sev));
}

/* ---------- Panels ---------- */
function collapseSharedPanel() {
  var panel = document.getElementById('sharedPanel');
  if (panel) {
    panel.style.display = 'none';
    panel.setAttribute('aria-hidden','true');
    panel.dataset.mode = '';
    panel.innerHTML = '';
  }
  var leftWrap  = document.getElementById('leftControlsWrapper');
  var rightWrap = document.getElementById('rightControlsWrapper');

  if (leftWrap) {
    var exBtns = leftWrap.querySelectorAll('.examples-btn');
    for (var i=0;i<exBtns.length;i++) {
      exBtns[i].textContent = 'Show examples';
      exBtns[i].setAttribute('aria-expanded','false');
      exBtns[i].classList.remove('active');
    }
  }
  if (rightWrap) {
    var rBtns = rightWrap.querySelectorAll('.viz-btn, .reasoning-btn');
    for (var j=0;j<rBtns.length;j++) {
      rBtns[j].textContent = rBtns[j].classList.contains('reasoning-btn') ? 'Show percentage reasoning' : 'Show visualization';
      rBtns[j].setAttribute('aria-expanded','false');
      rBtns[j].classList.remove('active');
    }
  }
}
function collapseReasoningPanel() {
  var panel = document.getElementById('reasoningPanel');
  if (panel) {
    panel.style.display = 'none';
    panel.setAttribute('aria-hidden','true');
    panel.innerHTML = '';
  }
}
function openSharedPanel(panel, mode) {
  if (!panel) return;
  panel.style.display = 'block';
  panel.setAttribute('aria-hidden','false');
  panel.dataset.mode = mode;

  var leftWrap  = document.getElementById('leftControlsWrapper');
  var rightWrap = document.getElementById('rightControlsWrapper');
  var exBtn = leftWrap ? leftWrap.querySelector('.examples-btn') : null;
  var vzBtn = rightWrap ? rightWrap.querySelector('.viz-btn') : null;

  if (mode === 'examples') {
    if (exBtn) exBtn.textContent = 'Hide examples';
    if (vzBtn) vzBtn.textContent = 'Show visualization';
  } else if (mode === 'viz') {
    if (vzBtn) vzBtn.textContent = 'Hide visualization';
    if (exBtn) exBtn.textContent = 'Show examples';
  }
}

/* ---------- Controls under the text ---------- */
function setupAuxToggles(node) {
  var leftWrap = document.getElementById('leftControlsWrapper');
  var rightWrap = document.getElementById('rightControlsWrapper');
  var panel = document.getElementById('sharedPanel');

  leftWrap.innerHTML = '';
  rightWrap.innerHTML = '';
  collapseSharedPanel();

  if (node.type === 'question') {
    // Examples (left)
    var examplesBtn = document.createElement('button');
    examplesBtn.textContent = 'Show examples';
    examplesBtn.className = 'examples-btn ctrl-btn';
    examplesBtn.setAttribute('aria-expanded', 'false');
    leftWrap.appendChild(examplesBtn);

    examplesBtn.onclick = function() {
      var isOpenExamples = panel.style.display === 'block' && panel.dataset.mode === 'examples';
      if (isOpenExamples) {
        collapseSharedPanel();
      } else {
        renderExamples(panel, node.id);
        openSharedPanel(panel, 'examples');
        examplesBtn.setAttribute('aria-expanded','true');
        examplesBtn.classList.add('active');
        var rightBtn = rightWrap.querySelector('.viz-btn, .reasoning-btn');
        if (rightBtn) { rightBtn.setAttribute('aria-expanded','false'); rightBtn.classList.remove('active'); }
      }
    };

    // Visualization (right) only for Q18 / Q20
    if (node.id === 'Q18' || node.id === 'Q20') {
      var vizBtn = document.createElement('button');
      vizBtn.textContent = 'Show visualization';
      vizBtn.className = 'viz-btn ctrl-btn';
      vizBtn.setAttribute('aria-expanded', 'false');
      rightWrap.appendChild(vizBtn);

      vizBtn.onclick = function() {
        var isOpenViz = panel.style.display === 'block' && panel.dataset.mode === 'viz';
        var src = node.id === 'Q18' ? 'diminishing_returns_curve.png' : 'inverted_u_curve.png';
        var alt = node.id === 'Q18'
          ? 'Diminishing Returns Curve: Effort/Resources vs Functional Results'
          : 'Inverted-U Curve: Effort/Resources vs Functional Results';
        if (isOpenViz) {
          collapseSharedPanel();
        } else {
          renderViz(panel, src, alt);
          openSharedPanel(panel, 'viz');
          vizBtn.setAttribute('aria-expanded','true');
          vizBtn.classList.add('active');
          examplesBtn.setAttribute('aria-expanded','false');
          examplesBtn.classList.remove('active');
        }
      };
    }

    // Percentage reasoning (RIGHT) on Q43/Q44
    if (node.id === 'Q43' || node.id === 'Q44') {
      var reasonBtn = document.createElement('button');
      reasonBtn.textContent = 'Show percentage reasoning';
      reasonBtn.className = 'reasoning-btn ctrl-btn';
      reasonBtn.setAttribute('aria-expanded','false');
      rightWrap.appendChild(reasonBtn);

      reasonBtn.onclick = function() {
        var rp = document.getElementById('reasoningPanel');
        var open = rp.style.display === 'block';
        if (open) {
          rp.style.display = 'none';
          rp.setAttribute('aria-hidden','true');
          reasonBtn.textContent = 'Show percentage reasoning';
          reasonBtn.setAttribute('aria-expanded','false');
          reasonBtn.classList.remove('active');
        } else {
          rp.style.display = 'block';
          rp.setAttribute('aria-hidden','false');
          reasonBtn.textContent = 'Hide percentage reasoning';
          reasonBtn.setAttribute('aria-expanded','true');
          reasonBtn.classList.add('active');
          rp.innerHTML = '';
          var p = document.createElement('p');
          p.textContent = 'Your current threshold is ' + currentThresholdPct + '%.';
          rp.appendChild(p);
          var img = document.createElement('img');
          img.src = 'linear_threshold_chart.png';
          img.alt = 'Linear Severity to Action Threshold: Threshold = 100% − (Severity × 10%)';
          rp.appendChild(img);
        }
      };
    }
  }
}

function renderExamples(panel, nodeId) {
  panel.innerHTML = '';
  var lines = examples[nodeId] || ["Example 1: [edit me]", "Example 2: [edit me]"];
  for (var i=0;i<lines.length;i++) {
    var p = document.createElement('p');
    p.textContent = lines[i];
    panel.appendChild(p);
  }
}
function renderViz(panel, src, alt) {
  panel.innerHTML = '';
  var img = document.createElement('img'); img.src = src; img.alt = alt;
  panel.appendChild(img);
}

/* ---------- Q29 slider with haptics, heat fill, and OUTSIDE ticks ---------- */
var lastVibeTs = 0;
function hapticBump() {
  if (!('vibrate' in navigator)) return;
  var now = Date.now();
  if (now - lastVibeTs < 80) return;
  navigator.vibrate(10);
  lastVibeTs = now;
}

function createTickRow(className, parent) {
  var row = document.createElement('div');
  row.className = 'tick-row ' + className;
  // create ticks at exact integer positions 1..10 (thumb center points)
  for (var i=1;i<=10;i++){
    var tick = document.createElement('div');
    tick.className = 'tick';
    var pct = ((i - 1) / 9) * 100; // 0..100 across thumb travel
    tick.style.left = pct + '%';
    row.appendChild(tick);
  }
  parent.appendChild(row);
  return row;
}

function showOrHideRiskInline(node) {
  var container = document.getElementById('riskInline');
  container.innerHTML = '';
  if (!node || node.id !== 'Q29') {
    container.style.display = 'none';
    container.setAttribute('aria-hidden','true');
    return;
  }
  container.style.display = 'block';
  container.setAttribute('aria-hidden','false');

  var sevDisplay = document.createElement('div');
  sevDisplay.className = 'sev-display';
  sevDisplay.id = 'sevDisplay';
  sevDisplay.textContent = '1';
  container.appendChild(sevDisplay);

  var row = document.createElement('div'); row.className = 'risk-row';

  // wrapper so we can place tick rows above & below
  var wrap = document.createElement('div');
  wrap.className = 'slider-wrap';

  var slider = document.createElement('input');
  slider.type = 'range'; slider.min = '1'; slider.max = '10'; slider.step = '1';
  slider.className = 'heat-slider';
  slider.setAttribute('list','riskTicks');
  slider.value = '1';

  // tick rows (outside the track)
  createTickRow('top', wrap);
  wrap.appendChild(slider);
  createTickRow('bottom', wrap);

  row.appendChild(wrap);
  container.appendChild(row);

  var ticks = document.createElement('datalist');
  ticks.id = 'riskTicks';
  for (var i=1;i<=10;i++){ var opt=document.createElement('option'); opt.value=String(i); ticks.appendChild(opt); }
  container.appendChild(ticks);

  function applyFromSeverity(sev) {
    var thr = 100 - sev * 10;   // linear threshold mapping
    currentThresholdPct = thr;  // sev=1 → 90%, sev=10 → 0%
    sevDisplay.textContent = String(sev);
    updateSliderFill(slider, sev);

    // Live update Q43/Q44 copy if visible
    if (currentNode && (currentNode.id === 'Q43' || currentNode.id === 'Q44')) {
      var textDiv = document.getElementById('text');
      var html = currentNode.text || '';
      html = currentNode.id === 'Q43' ? transformQ43(html) : transformQ44(html);
      textDiv.innerHTML = '<div class="result-text">' + html + '</div>';
    }
  }

  // Init visuals
  applyFromSeverity(1);

  slider.oninput = function() {
    var sev = parseInt(slider.value, 10);
    applyFromSeverity(sev);
    hapticBump();
  };
}

/* ---------- Nav ---------- */
function makeButton(label, cls, action) {
  var btn = document.createElement('button');
  btn.textContent = label; btn.className = cls; btn.onclick = action; return btn;
}
function goToNode(id) {
  closeAllPanels();

  if (currentNode && currentNode.id === 'Q6' && id === currentNode.yes) {
    q6WasYes = true;
  }
  var adjustedId = beforeEnterNode(id);

  var next = flowchart.find(function(n){ return n.id === adjustedId; });
  historyStack.push(currentNode ? currentNode.id : '');
  currentNode = next; renderNode(currentNode);
}
function goBack() {
  closeAllPanels();
  var prevId = historyStack.pop();
  var prev = flowchart.find(function(n){ return n.id === prevId; });
  currentNode = prev || currentNode; renderNode(currentNode);
}
function restart() {
  closeAllPanels();
  historyStack = [];
  currentSegment = "If You Should Act";
  currentNode = flowchart.find(function(n){ return n.id === "Q0"; });
  q6WasYes = false;
  renderNode(currentNode);
}

/* Skip to first WHEN screen (Q27) */
document.getElementById('skipBtn').addEventListener('click', function() {
  closeAllPanels();
  goToNode('Q27');
});

/* ---------- Render ---------- */
function renderNode(node) {
  closeAllPanels();

  var errorBox = document.getElementById('errorBox');
  errorBox.textContent = '';

  if (!node) {
    errorBox.textContent = "Error: Could not render this step (missing node). Check JSON IDs and links.";
    document.getElementById('text').textContent = '';
    document.getElementById('buttons').innerHTML = '';
    setHeadingText('');
    document.getElementById('backBtn').style.visibility = historyStack.length > 0 ? 'visible' : 'hidden';
    document.getElementById('restartTop').style.display = 'inline-block';
    return;
  }

  var previousSegment = currentSegment;
  var thisSegment = getSegmentForNodeId(node.id);
  if (thisSegment !== previousSegment && node.id !== 'Q0') flashHeadingColor(thisSegment);

  currentSegment = thisSegment;
  setHeadingText(node.id);

  var textDiv = document.getElementById('text');
  var displayHTML = node.text || '';
  if (node.id === 'Q43') {
    displayHTML = transformQ43(displayHTML);
    textDiv.innerHTML = '<div class="result-text">' + displayHTML + '</div>';
  } else if (node.id === 'Q44') {
    displayHTML = transformQ44(displayHTML);
    textDiv.innerHTML = '<div class="result-text">' + displayHTML + '</div>';
  } else {
    textDiv.innerHTML = displayHTML;
  }

  document.getElementById('backBtn').style.visibility = historyStack.length > 0 ? 'visible' : 'hidden';

  setupAuxToggles(node);
  showOrHideRiskInline(node);

  var btns = document.getElementById('buttons');
  btns.innerHTML = '';
  var restartTop = document.getElementById('restartTop');

  if (node.type === 'result') {
    restartTop.style.display = 'none';
    btns.classList.add('center');
    var restartCentered = makeButton('Restart', 'restart', function(){ restart(); });
    restartCentered.style.flex = '0 0 auto';
    btns.appendChild(restartCentered);
  } else {
    restartTop.style.display = 'inline-block';
    btns.classList.remove('center');

    if (node.type === 'question') {
      var yesBtn = makeButton('Yes', 'yes', function(){ goToNode(node.yes); });
      var noBtn  = makeButton('No',  'no',  function(){ goToNode(node.no); });
      btns.appendChild(yesBtn);
      btns.appendChild(noBtn);
      if (node.same) btns.appendChild(makeButton('Roughly the same', 'same', function(){ goToNode(node.same); }));
    } else if (node.type === 'info') {
      btns.appendChild(makeButton('Next', 'next', function(){ goToNode(node.next); }));
    }
  }
}

/* Initial render */
renderNode(currentNode);
</script>
</body>
</html>
