<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Discernment Guide</title>

<!-- Favicon set -->
<link rel="icon" type="image/svg+xml" href="favicon.svg">
<link rel="icon" type="image/png" sizes="16x16" href="favicon_16.png">
<link rel="icon" type="image/png" sizes="32x32" href="favicon_32.png">
<link rel="icon" type="image/png" sizes="48x48" href="favicon_48.png">
<link rel="icon" type="image/png" sizes="64x64" href="favicon_64.png">
<link rel="apple-touch-icon" sizes="180x180" href="favicon_180.png">
<link rel="icon" type="image/png" sizes="192x192" href="favicon_192.png">
<link rel="icon" type="image/png" sizes="256x256" href="favicon_256.png">
<link rel="icon" type="image/png" sizes="384x384" href="favicon_384.png">
<link rel="icon" type="image/png" sizes="512x512" href="favicon_512.png">
<link rel="shortcut icon" href="favicon.ico">
<!-- cache-bust fallback -->
<link rel="icon" type="image/png" href="favicon_512.png?v=2">

<style>
  :root { --btn-pad-y:10px; --btn-pad-x:12px; }
  body { font-family: Arial, sans-serif; background:#f7f7f7; margin:0; padding:0; }
  .container { max-width: 650px; margin:auto; padding:20px; }
  .top-bar { display:flex; justify-content:space-between; margin-bottom:10px; }
  .card {
    background:#fff; padding:20px; border-radius:8px;
    box-shadow:0 2px 6px rgba(0,0,0,0.1); min-height:280px;
    display:flex; flex-direction:column; justify-content:space-between;
  }

  /* Header / segment heading row (left label + right skip) */
  .segment-heading {
    display:flex; align-items:center; justify-content:space-between;
    font-size:1.8em; font-weight:bold; margin-bottom:15px; padding:8px;
    border-bottom:2px solid #ddd; gap:12px; transition: color .5s ease;
  }
  .segment-title { display:inline-flex; align-items:center; gap:8px; }
  .segment-title img.logo { height:1.2em; width:auto; vertical-align:middle; margin-right:6px; }

  .flash-gold { color: goldenrod !important; }
  .flash-green { color: #2e7d32 !important; }

  /* Buttons (global) */
  button { flex:1; padding:var(--btn-pad-y) var(--btn-pad-x); font-size:1em; border:none; border-radius:5px; cursor:pointer; }
  button.yes { background:#4CAF50; color:#fff; }
  button.no { background:#F44336; color:#fff; }
  button.next { background:#2196F3; color:#fff; }
  button.back { background:#555; color:#fff; flex:0 0 auto; }
  button.restart { background:#9C27B0; color:#fff; flex:0 0 auto; }
  button.examples-btn, button.viz-btn, button.reasoning-btn { background:#9E9E9E; color:#fff; }
  .ctrl-btn { flex:1; }
  button.active { outline:2px solid #000; }

  /* New: the blue “Roughly the same” button */
  button.same { background:#1E88E5; color:#fff; }

  /* Skip button */
  .segment-heading .skip-btn {
    display:inline-flex; align-items:center; justify-content:center;
    flex:0 0 auto; padding:var(--btn-pad-y) var(--btn-pad-x);
    font-size:1rem; line-height:1; border:none; border-radius:5px; cursor:pointer;
    background:#e9e9e9; color:#333;
  }
  .segment-heading .skip-btn:hover { background:#dedede; }

  .text { font-size:1.3em; margin-bottom:12px; white-space:pre-wrap; }

  /* Controls row under the text */
  .controls-row { display:flex; gap:10px; margin:6px 0 18px 0; }
  .left-controls, .right-controls { flex:1; display:flex; gap:10px; }

  .panel {
    display:none; border:1px solid #eee; border-radius:6px; padding:10px; background:#fafafa;
    margin-bottom:18px;
  }
  .panel p { margin:6px 0; }
  .panel img { width:100%; height:auto; display:block; }

  /* Bottom buttons */
  .buttons { display:flex; gap:10px; flex-wrap:wrap; justify-content:flex-start; }
  .buttons.center { justify-content:center; }

  /* Q29 slider (renumbered from Q25) */
  .risk-inline { display:none; border:1px solid #eee; border-radius:6px; padding:12px; background:#fafafa; margin:8px 0 18px 0; }
  .sev-display { text-align:center; font-size:1.8em; font-weight:bold; margin-bottom:8px; }
  .risk-row { display:flex; align-items:center; gap:10px; margin:0; }
  .risk-row input[type="range"] { width:100%; }
  .risk-ticks { display:block; width:100%; }

  .error { color:#B00020; font-size:0.95em; margin-top:8px; }

  /* Compact list spacing */
  .result-text { margin: 0; padding: 0; }
  .result-text p { margin: 0.4em 0; }
  .result-text ul { margin: 0.25em 0; padding-left: 1.2em; }
  .result-text li { margin: 0.25em 0; }
</style>
</head>
<body>
<div class="container">
  <div class="top-bar">
    <button class="back" id="backBtn" onclick="goBack()">Back</button>
    <button class="restart" id="restartTop" onclick="restart()">Restart</button>
  </div>

  <div class="card">
    <div id="segmentHeading" class="segment-heading">
      <span id="segmentTitle" class="segment-title"></span>
      <button id="skipBtn" class="skip-btn" style="display:none;" title="Skip to when you should act">Skip ⏭</button>
    </div>

    <div>
      <div id="text" class="text"></div>

      <div class="controls-row">
        <div id="leftControlsWrapper" class="left-controls"></div>
        <div id="rightControlsWrapper" class="right-controls"></div>
      </div>

      <div id="sharedPanel" class="panel" aria-hidden="true"></div>
      <div id="riskInline" class="risk-inline" aria-hidden="true"></div>
      <div id="reasoningPanel" class="panel" aria-hidden="true"></div>

      <div id="errorBox" class="error"></div>
    </div>

    <div id="buttons" class="buttons"></div>
  </div>
</div>

<script>
/* =========================
   RENumbering Map (for your reference)
   Old → New
   Q1→Q1, Q2→Q2, Q3→Q3, Q4→Q4, Q50→Q5, Q60→Q6, Q70→Q7,
   Q5→Q8, Q6→Q9, Q7→Q10, Q8→Q11, Q9→Q12, Q10→Q13,
   Q13→Q14, Q130→Q15, Q140→Q16, Q150→Q17, Q14→Q18,
   Q15→Q19 (info), Q16→Q20, Q17→Q21 (info), Q18→Q22,
   Q19→Q23, Q20→Q24, Q21→Q25, Q22→Q26,
   Q23→Q27, Q24→Q28, Q25→Q29 (info), Q26→Q30,
   Q27→Q31, Q28→Q32, Q290→Q33, Q300→Q34,
   Q29→Q35, Q30→Q36, Q31→Q37, Q32→Q38, Q33→Q39,
   Q34→Q40, Q35→Q41, Q36→Q42, Q37→Q43
   Results unchanged: R1,R2,R30,R3,R4,R5,R6,R7,R8
========================= */

// ======= FLOW (Q0–Q43) =======
const flowchart = [
  { "id": "Q0",  "type": "info",     "text": "Welcome! This flow chart guide helps you determine both <i>IF</i> and <i>WHEN</i> you should act on an issue. This will help to avoid wasting resources and time, and getting stuck in <i>analysis paralysis</i>.\nYou’ll answer simple Yes/No questions (and a slider later). Tap Next to begin.", "next": "Q1" },

  /* ===== IF YOU SHOULD ACT ===== */
  { "id": "Q1",  "type": "question", "text": "Are there any other more important things to do or think about right now?", "yes": "R1",  "no": "Q2" },
  { "id": "Q2",  "type": "question", "text": "Is there a current <i>real problem</i> or desired functional QoL (quality of life) improvement, rather than just a <i>“problem”</i> or preference that doesn’t affect performance or outcomes?", "yes": "Q8",  "no": "Q3" },
  { "id": "Q3",  "type": "question", "text": "Is there cause for a potential <i>real problem</i>, rather than just a <i>“problem”</i> that doesn’t affect performance or outcomes?", "yes": "Q5",  "no": "Q4" },
  { "id": "Q4",  "type": "question", "text": "Is there cause for a POTENTIAL cause for a POTENTIAL <i>real problem</i>, rather than just a <i>“problem”</i> that doesn’t affect performance or outcomes?", "yes": "Q8",  "no": "R2" },

  { "id": "Q5",  "type": "question", "text": "Is the potential problem inevitable if left unaddressed?", "yes": "Q8",  "no": "Q6" },
  { "id": "Q6",  "type": "question", "text": "Would the expected downsides of <i>NOT addressing this issue</i> outweigh the downsides <i>OF addressing this issue</i>?", "yes": "Q8",  "no": "Q16", "same": "Q7" },
  { "id": "Q7",  "type": "question", "text": "Is the problem more likely to occur than not if left unaddressed?", "yes": "Q8",  "no": "Q16" },

  { "id": "Q8",  "type": "question", "text": "Is there a solution (or at least partial solution) to the problem/potential problem even if it’s currently unavailable (or a means of bringing about the QoL improvement)?", "yes": "Q9",  "no": "R3" },
  { "id": "Q9",  "type": "question", "text": "Can this solution or QoL improvement be <i>guaranteed</i> by <i>your</i> influence?", "yes": "Q12", "no": "Q10" },
  { "id": "Q10", "type": "question", "text": "Do everything in your power first to achieve the desired result, but know that past that it’s out of your hands, and <i>worrying and obsessing won’t change anything and is unhealthy</i>. Is there anything further you can do?", "yes": "Q12", "no": "Q11" },
  { "id": "Q11", "type": "question", "text": "Is there an alternative solution that would solve the problem (or improve QoL) in a way that’s within your control or in a <i>better overall way</i>?", "yes": "R4",  "no": "R2" },

  { "id": "Q12", "type": "question", "text": "Does this solution or QoL improvement involve gaining information that would be <i>valuable in the future</i>?", "yes": "Q13", "no": "Q14" },
  { "id": "Q13", "type": "question", "text": "Would the <i>information alone</i> gained from doing this outweigh the downsides it would likely cause to make this happen?", "yes": "Q27", "no": "Q14" },

  { "id": "Q14", "type": "question", "text": "Would the <i>benefits</i> of addressing this issue outweigh any <i>downsides</i> it might likely cause?", "yes": "Q18", "no": "Q16", "same": "Q15" },
  { "id": "Q15", "type": "question", "text": "All things considered and despite the downsides involved, would you rather address it than not?", "yes": "Q18", "no": "Q16" },
  { "id": "Q16", "type": "question", "text": "Is there a time further down the road that the criteria from the <i>previous question</i> could be true?", "yes": "R30", "no": "Q17" },
  { "id": "Q17", "type": "question", "text": "Is there an alternative solution that would solve the problem (or improve QoL) in a way that’s worth it or in a <i>better overall way</i>?", "yes": "R4",  "no": "R2" },

  { "id": "Q18", "type": "question", "text": "Does addressing this issue involve a <i>diminishing returns</i> curve for effort applied?", "yes": "Q19", "no": "Q20" },
  { "id": "Q19", "type": "info",     "text": "Find the <i>point of diminishing returns</i> and stop there. If you tend to get absorbed in an activity, find an alternative approach that solves the problem or improves QoL <i>without the addictive pull</i> and possibly even in a <i>better overall way</i>. Treat this approach as a \"better,\" more effective overall solution. If it's not available, you may use the original approach if needed—but <i>only</i> with a pre-set time limit and timer, after which you must stop and re-evaluate.", "next": "Q20" },
  { "id": "Q20", "type": "question", "text": "Does addressing this issue directly involve an <i>inverted-U curve</i> for specific effort applied with an <i>objective sweet spot</i> where clear information is available to you?", "yes": "Q21", "no": "Q22" },
  { "id": "Q21", "type": "info",     "text": "Wait until there aren’t any other more important things to do, then if it’s worth it to you, find that <i>sweet spot</i>. If not, put in as much effort as you deem worth it.", "next": "Q27" },

  { "id": "Q22", "type": "question", "text": "In practice and given time, would a <i>worthwhile functional difference</i> likely be noticed if the issue was solved/addressed?", "yes": "Q23", "no": "R2" },
  { "id": "Q23", "type": "question", "text": "Would solving/addressing it help get rid of/prevent the problem (or improve QoL) in the <i>long term</i>?", "yes": "Q27", "no": "Q24" },
  { "id": "Q24", "type": "question", "text": "Would solving/addressing it help get rid of/prevent the problem (or improve QoL) in the <i>short term</i>?", "yes": "Q25", "no": "R2" },
  { "id": "Q25", "type": "question", "text": "Is it logically worth solving/addressing <i>EVERY time</i>? (Or this time knowing it’s <i>temporary</i>?)", "yes": "Q27", "no": "Q26" },
  { "id": "Q26", "type": "question", "text": "Is there an alternative solution that would solve the problem (or improve QoL), in the long term or in a <i>better overall way</i>?", "yes": "R4",  "no": "R2" },

  /* ===== WHEN YOU SHOULD ACT ===== */
  { "id": "Q27", "type": "question", "text": "Does this address a potential <i>future</i> problem?", "yes": "Q28", "no": "Q31" },
  { "id": "Q28", "type": "question", "text": "Does addressing this issue involve <i>preventative maintenance</i>?", "yes": "Q33", "no": "Q31" },

  /* Severity selection (renumbered) */
  { "id": "Q29", "type": "info",     "text": "Set the estimated catastrophic severity if you waited too long to act. (1-10)", "next": "Q30" },
  { "id": "Q30", "type": "question", "text": "Would there be <i>guaranteed clear telltale signs</i> of future functional failure before it actually happened, with a big enough window of time to address it properly in advance?", "yes": "Q42", "no": "Q43" },

  { "id": "Q31", "type": "question", "text": "Is this the <i>most effective solution</i> you know of (that meets the previous criteria), assuming you could do it <i>now</i>?", "yes": "Q35", "no": "Q32" },
  { "id": "Q32", "type": "question", "text": "Have you considered <i>all better solutions</i> you know of?", "yes": "Q35", "no": "R4" },

  { "id": "Q33", "type": "question", "text": "Is this the <i>most effective solution</i> you know of (that meets the previous criteria)?", "yes": "Q29", "no": "Q34" },
  { "id": "Q34", "type": "question", "text": "Have you considered <i>all better solutions</i> you know of?", "yes": "Q29", "no": "R4" },

  { "id": "Q35", "type": "question", "text": "Is this solution <i>currently</i> available?", "yes": "Q39", "no": "Q37" },
  { "id": "Q36", "type": "question", "text": "Is there a <i>better time</i> down the road to solve/address this to <i>maximize value</i>?", "yes": "Q37", "no": "R6" },
  { "id": "Q37", "type": "question", "text": "Assuming you waited until it was available, would the <i>benefits</i> of using this solution outweigh the <i>downsides</i> of having to wait?", "yes": "Q40", "no": "Q38" },
  { "id": "Q38", "type": "question", "text": "Is there a <i>better</i> solution you know of?", "yes": "R4",  "no": "R3" },
  { "id": "Q39", "type": "question", "text": "Is there a <i>better time</i> further down the road to solve/address this to <i>maximize value</i>?", "yes": "R7",  "no": "R6" },
  { "id": "Q40", "type": "question", "text": "Is there a <i>better time</i> further down the road than when this solution is available to solve/address this to <i>maximize value</i>?", "yes": "R7",  "no": "R5" },
  { "id": "Q41", "type": "question", "text": "Is there a <i>better time</i> further down the road than at that time to solve/address this to <i>maximize value</i>?", "yes": "R7",  "no": "R5" },

  /* WHEN listy screens (threshold substitution) */
  { "id": "Q42", "type": "question", "text": "Normally you should solve/address it as soon as both of the following are true: <ul><li><i>Those telltale signs</i> indicate that failure is approaching.</li><li>The <i>estimated chance of failure</i> is nearing or greater than 50%.</li></ul>\nHowever, is there a <i>better time</i> before or after that time to solve/address this to <i>maximize value</i>?", "yes": "R7", "no": "R8" },
  { "id": "Q43", "type": "question", "text": "Normally you should solve/address it as soon as the <i>estimated chance of failure</i> is nearing or greater than 50%.\nHowever, is there a <i>better time</i> before or after that time to solve/address this to <i>maximize value</i>?", "yes": "R7", "no": "R8" },

  /* RESULTS */
  { "id": "R1",  "type": "result",   "text": "Worry about this <i>once those things are addressed</i> and the time is right." },
  { "id": "R2",  "type": "result",   "text": "<i>Don’t worry about it:)</i>" },
  { "id": "R30", "type": "result",   "text": "If that time ever does come, re-evaluate the issue. Until then, don't worry about it:)" },
  { "id": "R3",  "type": "result",   "text": "Wait until there aren’t any other more important things to do, then if it’s worth it to you, <i>find a solution or solutions</i>. If not, put in as much effort as you deem worth it." },
  { "id": "R4",  "type": "result",   "text": "Consider any other solutions, from best to worst, if you haven’t already. Run them through the chart." },
  { "id": "R5",  "type": "result",   "text": "Wait until the <i>best solution</i> given the circumstances is available, then solve it once there aren’t any other more important things to do." },
  { "id": "R6",  "type": "result",   "text": "Address it <i>sooner than later</i>, once there aren’t any other more important things to do." },
  { "id": "R7",  "type": "result",   "text": "Wait until that better time, then solve/address it once there aren't any other more important things to do. Consider any other options that could also work and be worth it until then." },
  { "id": "R8",  "type": "result",   "text": "Solve/address it as soon as the criteria from the <i>previous slide</i> (before the question) come true, once there aren’t any other more important things to do." }
];

/* ===== EXAMPLES (renumbered + expanded) ===== */
const examples = {
  Q1:[ "Deadline today > TV shopping can wait. (Applies)",
       "Nothing urgent today; small decisions okay. (Does not apply)"],
  Q2:[ "Sink leaking (function not met). (Applies)",
       "Prefer different bag color; no functional impact. (Does not apply)"],
  Q3:[ "Laptop fan noise could signal failure. (Applies)",
       "Phone works fine; vague worry only. (Does not apply)"],
  Q4:[ "Dust buildup could lead to overheating later. (Applies)",
       "Hand-wavy fear something ‘might’ happen. (Does not apply)"],
  Q5:[ "Old lithium battery will eventually degrade. (Applies)",
       "A one-off pop-up likely won’t recur. (Does not apply)"],
  Q6:[ "Not patching a critical vuln costs more than patching. (Applies)",
       "Cosmetic bug costs more to fix than to leave. (Does not apply)",
       "Roughly the same: patch disruptive but risk seems low. (Same)"],
  Q7:[ "Slow leak likely to spread if ignored. (Applies)",
       "Contained glitch unlikely to recur. (Does not apply)"],

  Q8:[ "Backordered replacement part exists. (Applies)",
       "No known fix or workaround yet. (Does not apply)"],
  Q9:[ "You can approve repair and it will happen. (Applies)",
       "You can’t guarantee someone else’s decision. (Does not apply)"],
  Q10:["Escalate once; beyond that it’s out of your hands. (Applies)",
       "Citywide outage: nothing else to do. (Does not apply)"],
  Q11:["Generator under your control solves outage. (Applies)",
       "All options rely on luck/others. (Does not apply)"],

  Q12:["Trial a tool to learn for future value. (Applies)",
       "Tedious workaround teaches nothing. (Does not apply)"],
  Q13:["Quick screening with minimal downside yields info. (Applies)",
       "Disassembling expensive gear ‘just to see’ isn’t worth it. (Does not apply)"],

  Q14:["Repairing roof leak prevents major damage. (Applies)",
       "Risky mod for marginal benefit. (Does not apply)",
       "Roughly the same: benefits ≈ downsides. (Same)"],
  Q15:["Despite tradeoffs, you’d still rather fix it. (Applies)",
       "Given tradeoffs, you’d rather not. (Does not apply)"],
  Q16:["Seasonal downtime could flip the calculus later. (Applies)",
       "No foreseeable time changes the calculus. (Does not apply)"],
  Q17:["Alternative approach is cheaper/better overall. (Applies)",
       "No better option fits goals. (Does not apply)"],

  Q18:["Polishing beyond ‘good enough’ adds little. (Applies)",
       "Critical bug: every hour matters. (Does not apply)"],
  Q20:["Exercise intensity has a sweet spot. (Applies)",
       "Filing taxes—no ‘sweet spot,’ just finish. (Does not apply)"],

  Q22:["HDD → SSD: noticeable improvement. (Applies)",
       "Gold HDMI vs regular: no difference. (Does not apply)"],
  Q23:["Sealing driveway cracks extends life. (Applies)",
       "Cosmetic touch-up that fades in a week. (Does not apply)"],
  Q24:["Decongestant restores sleep tonight. (Applies)",
       "Reorganizing a drawer won’t help urgent issue. (Does not apply)"],
  Q25:["Seatbelt is always worth it. (Applies)",
       "Washing the car daily isn’t. (Does not apply)"],
  Q26:["Replace worn laptop vs. another costly repair. (Applies)",
       "No alternative truly better long-term. (Does not apply)"],

  Q27:["Replace timing belt before end-of-life. (Applies)",
       "Fixing already cracked screen is a current problem. (Does not apply)"],
  Q28:["Changing HVAC filters to prevent breakdown. (Applies)",
       "Repainting for color (not preventative). (Does not apply)"],

  Q30:["Squealing brakes give clear warning window. (Applies)",
       "Timing belt can fail without warning. (Does not apply)"],

  Q31:["You’d pick this method if you could do it now. (Applies)",
       "You know a better option but aren’t picking it. (Does not apply)"],
  Q32:["You compared and ruled out better options. (Applies)",
       "You haven’t checked obvious alternatives. (Does not apply)"],

  Q33:["This truly is the best preventative option. (Applies)",
       "A stronger preventative option likely exists. (Does not apply)"],
  Q34:["You’ve ruled out better preventative options. (Applies)",
       "You still need to look at alternatives. (Does not apply)"],

  Q35:["Part in stock; appointments available. (Applies)",
       "Part backordered two weeks. (Does not apply)"],
  Q36:["Off-season timing makes it cheaper/easier. (Applies)",
       "Waiting won’t improve value; risk rises. (Does not apply)"],
  Q37:["Waiting saves a lot with little downside. (Applies)",
       "Waiting causes outages or stress. (Does not apply)"],
  Q38:["Plan B works now. (Applies)",
       "No next-best option reasonably solves it. (Does not apply)"],
  Q39:["Do it during a scheduled break. (Applies)",
       "No later window beats now. (Does not apply)"],
  Q40:["After availability, a later lull saves hassle. (Applies)",
       "Once available, sooner is better. (Does not apply)"],
  Q41:["An even later window improves value. (Applies)",
       "Doing it then is best already. (Does not apply)"],

  Q42:["Both: warning signs appear AND probability passes threshold. (Applies)",
       "Neither condition has been met. (Does not apply)"],
  Q43:["Probability alone passes threshold (no clear telltales). (Applies)",
       "Probability remains well below threshold. (Does not apply)"]
};

// ======= STATE =======
let currentThresholdPct = 90;

// ======= APP LOGIC =======
let historyStack = [];
let currentNode = flowchart.find(n => n.id === "Q0");  // Start at intro
let currentSegment = "If You Should Act";               // default label

function getSegmentForNodeId(id) {
  if (!id || id[0] !== 'Q') return currentSegment;
  const m = /^Q(\d+)$/.exec(id);
  if (!m) return currentSegment;
  const num = parseInt(m[1], 10);
  return num >= 27 ? "When You Should Act" : "If You Should Act";
}

function setHeadingText(nodeId) {
  const title = document.getElementById('segmentTitle');
  const skipBtn = document.getElementById('skipBtn');

  if (nodeId === 'Q0') {
    title.innerHTML =
      "<img src='favicon_512.png' srcset='favicon_64.png 1x, favicon_256.png 2x, favicon_512.png 3x' alt='Discernment Logo' class='logo'>Discernment Guide";
    skipBtn.style.display = 'none';
    return;
  }

  title.textContent = (currentSegment === "If You Should Act") ? "⚖️ If You Should Act" : "⏳ When You Should Act";
  // Show Skip only in IF segment
  skipBtn.style.display = (currentSegment === "If You Should Act") ? 'inline-block' : 'none';
}

function flashHeadingColor(targetSegment) {
  if (currentNode && currentNode.id === 'Q0') return;
  const headingDiv = document.getElementById('segmentHeading');
  const cls = (targetSegment === "If You Should Act") ? 'flash-green' : 'flash-gold';
  headingDiv.classList.add(cls);
  setTimeout(() => headingDiv.classList.remove(cls), 1500);
}

/* Close panels when changing screens */
function closeAllPanels() {
  collapseSharedPanel();
  collapseReasoningPanel();
  const risk = document.getElementById('riskInline');
  if (risk) {
    risk.style.display = 'none';
    risk.setAttribute('aria-hidden','true');
  }
}

/* Threshold text replacement for Q42/Q43 (renumbered from Q36/Q37) */
function applyThresholdClauseTo(html) {
  if (currentThresholdPct <= 0) {
    const liRe = /<li>[\s\S]*?estimated[^<]*chance[^<]*failure[\s\S]*?<\/li>/i;
    return html.replace(liRe, '<li>There is even a <i>SMALL</i> chance of failure.</li>');
  }
  return html.replace(/(?:nearing\s+or\s+greater\s+than\s*)?50%/gi, `${currentThresholdPct}%`);
}

function renderNode(node) {
  closeAllPanels();

  const errorBox = document.getElementById('errorBox');
  errorBox.textContent = '';

  if (!node) {
    errorBox.textContent = "Error: Could not render this step (missing node). Check JSON IDs and links.";
    document.getElementById('text').textContent = '';
    document.getElementById('buttons').innerHTML = '';
    setHeadingText('');
    document.getElementById('backBtn').style.visibility = historyStack.length > 0 ? 'visible' : 'hidden';
    document.getElementById('restartTop').style.display = 'inline-block';
    return;
  }

  const previousSegment = currentSegment;
  const thisSegment = getSegmentForNodeId(node.id);
  if (thisSegment !== previousSegment && node.id !== 'Q0') flashHeadingColor(thisSegment);

  currentSegment = thisSegment;
  setHeadingText(node.id);

  const textDiv = document.getElementById('text');
  let displayHTML = node.text || '';
  if (node.id === 'Q42' || node.id === 'Q43') {
    displayHTML = applyThresholdClauseTo(displayHTML);
    textDiv.innerHTML = `<div class="result-text">${displayHTML}</div>`;
  } else {
    textDiv.innerHTML = displayHTML;
  }

  document.getElementById('backBtn').style.visibility = historyStack.length > 0 ? 'visible' : 'hidden';

  setupAuxToggles(node);
  showOrHideRiskInline(node);

  const btns = document.getElementById('buttons');
  btns.innerHTML = '';
  const restartTop = document.getElementById('restartTop');

  if (node.type === 'result') {
    restartTop.style.display = 'none';
    btns.classList.add('center');
    const restartCentered = makeButton('Restart', 'restart', () => restart());
    restartCentered.style.flex = '0 0 auto';
    btns.appendChild(restartCentered);
  } else {
    restartTop.style.display = 'inline-block';
    btns.classList.remove('center');

    if (node.type === 'question') {
      btns.appendChild(makeButton('Yes', 'yes', () => goToNode(node.yes)));
      btns.appendChild(makeButton('No',  'no',  () => goToNode(node.no)));
      // Add blue “Roughly the same” if present
      if (node.same) btns.appendChild(makeButton('Roughly the same', 'same', () => goToNode(node.same)));
    } else if (node.type === 'info') {
      btns.appendChild(makeButton('Next', 'next', () => goToNode(node.next)));
    }
  }
}

/* ---------- Panels ---------- */
function collapseSharedPanel() {
  const panel = document.getElementById('sharedPanel');
  if (panel) {
    panel.style.display = 'none';
    panel.setAttribute('aria-hidden','true');
    panel.dataset.mode = '';
    panel.innerHTML = '';
  }
  const leftWrap  = document.getElementById('leftControlsWrapper');
  const rightWrap = document.getElementById('rightControlsWrapper');
  leftWrap?.querySelectorAll('.examples-btn')?.forEach(btn => {
    btn.textContent = 'Show examples';
    btn.setAttribute('aria-expanded','false');
    btn.classList.remove('active');
  });
  rightWrap?.querySelectorAll('.viz-btn')?.forEach(btn => {
    btn.textContent = 'Show visualization';
    btn.setAttribute('aria-expanded','false');
    btn.classList.remove('active');
  });
}
function collapseReasoningPanel() {
  const panel   = document.getElementById('reasoningPanel');
  const leftWrap = document.getElementById('leftControlsWrapper');
  if (panel) {
    panel.style.display = 'none';
    panel.setAttribute('aria-hidden','true');
    panel.innerHTML = '';
  }
  const btn = leftWrap?.querySelector('.reasoning-btn');
  if (btn) {
    btn.textContent = 'Show percentage reasoning';
    btn.setAttribute('aria-expanded','false');
    btn.classList.remove('active');
  }
}
function openSharedPanel(panel, mode) {
  if (!panel) return;
  panel.style.display = 'block';
  panel.setAttribute('aria-hidden','false');
  panel.dataset.mode = mode;

  const leftWrap  = document.getElementById('leftControlsWrapper');
  const rightWrap = document.getElementById('rightControlsWrapper');
  const exBtn = leftWrap?.querySelector('.examples-btn');
  const vzBtn = rightWrap?.querySelector('.viz-btn');

  if (mode === 'examples') {
    if (exBtn) exBtn.textContent = 'Hide examples';
    if (vzBtn) vzBtn.textContent = 'Show visualization';
  } else if (mode === 'viz') {
    if (vzBtn) vzBtn.textContent = 'Hide visualization';
    if (exBtn) exBtn.textContent = 'Show examples';
  }
}

/* ---------- Controls under the text ---------- */
function setupAuxToggles(node) {
  const leftWrap = document.getElementById('leftControlsWrapper');
  const rightWrap = document.getElementById('rightControlsWrapper');
  const panel = document.getElementById('sharedPanel');

  leftWrap.innerHTML = '';
  rightWrap.innerHTML = '';
  collapseSharedPanel();

  if (node.type === 'question') {
    // Examples (left)
    const examplesBtn = document.createElement('button');
    examplesBtn.textContent = 'Show examples';
    examplesBtn.className = 'examples-btn ctrl-btn';
    examplesBtn.setAttribute('aria-expanded', 'false');
    leftWrap.appendChild(examplesBtn);

    examplesBtn.onclick = () => {
      const isOpenExamples = panel.style.display === 'block' && panel.dataset.mode === 'examples';
      if (isOpenExamples) {
        collapseSharedPanel();
      } else {
        renderExamples(panel, node.id);
        openSharedPanel(panel, 'examples');
        examplesBtn.setAttribute('aria-expanded','true');
        examplesBtn.classList.add('active');
        const vizBtn = rightWrap.querySelector('.viz-btn');
        if (vizBtn) { vizBtn.setAttribute('aria-expanded','false'); vizBtn.classList.remove('active'); }
      }
    };

    // Visualization (right) only for Q18 / Q20 (diminishing returns & inverted-U)
    if (node.id === 'Q18' || node.id === 'Q20') {
      const vizBtn = document.createElement('button');
      vizBtn.textContent = 'Show visualization';
      vizBtn.className = 'viz-btn ctrl-btn';
      vizBtn.setAttribute('aria-expanded', 'false');
      rightWrap.appendChild(vizBtn);

      vizBtn.onclick = () => {
        const isOpenViz = panel.style.display === 'block' && panel.dataset.mode === 'viz';
        const src = node.id === 'Q18' ? 'diminishing_returns_curve.png' : 'inverted_u_curve.png';
        const alt = node.id === 'Q18'
          ? 'Diminishing Returns Curve: Effort/Resources vs Functional Results'
          : 'Inverted-U Curve: Effort/Resources vs Functional Results';
        if (isOpenViz) {
          collapseSharedPanel();
        } else {
          renderViz(panel, src, alt);
          openSharedPanel(panel, 'viz');
          vizBtn.setAttribute('aria-expanded','true');
          vizBtn.classList.add('active');
          examplesBtn.setAttribute('aria-expanded','false');
          examplesBtn.classList.remove('active');
        }
      };
    }
  }

  // Reasoning panel appears on Q42/Q43 (WHEN threshold)
  if (node.id === 'Q42' || node.id === 'Q43') {
    const reasonBtn = document.createElement('button');
    reasonBtn.textContent = 'Show percentage reasoning';
    reasonBtn.className = 'reasoning-btn ctrl-btn';
    reasonBtn.setAttribute('aria-expanded','false');
    reasonBtn.onclick = () => {
      const rp = document.getElementById('reasoningPanel');
      const open = rp.style.display === 'block';
      if (open) {
        rp.style.display = 'none';
        rp.setAttribute('aria-hidden','true');
        reasonBtn.textContent = 'Show percentage reasoning';
        reasonBtn.setAttribute('aria-expanded','false');
        reasonBtn.classList.remove('active');
      } else {
        rp.style.display = 'block';
        rp.setAttribute('aria-hidden','false');
        reasonBtn.textContent = 'Hide percentage reasoning';
        reasonBtn.setAttribute('aria-expanded','true');
        reasonBtn.classList.add('active');
        rp.innerHTML = '';
        const p = document.createElement('p');
        p.textContent = `Your current threshold is ${currentThresholdPct}%.`;
        rp.appendChild(p);
        const img = document.createElement('img');
        img.src = 'linear_threshold_chart.png';
        img.alt = 'Linear Severity to Action Threshold: Threshold = 100% − (Severity × 10%)';
        rp.appendChild(img);
      }
    };
    leftWrap.appendChild(reasonBtn);
  }
}

function renderExamples(panel, nodeId) {
  panel.innerHTML = '';
  const lines = examples[nodeId] || ["Example 1: [edit me]", "Example 2: [edit me]"];
  lines.forEach(line => {
    const p = document.createElement('p');
    p.textContent = line;
    panel.appendChild(p);
  });
}
function renderViz(panel, src, alt) {
  panel.innerHTML = '';
  const img = document.createElement('img'); img.src = src; img.alt = alt;
  panel.appendChild(img);
}

/* ---------- Q29 severity slider ---------- */
function showOrHideRiskInline(node) {
  const container = document.getElementById('riskInline');
  container.innerHTML = '';
  if (!node || node.id !== 'Q29') {
    container.style.display = 'none';
    container.setAttribute('aria-hidden','true');
    return;
  }
  container.style.display = 'block';
  container.setAttribute('aria-hidden','false');

  const sevDisplay = document.createElement('div');
  sevDisplay.className = 'sev-display';
  sevDisplay.id = 'sevDisplay';
  sevDisplay.textContent = '1';
  container.appendChild(sevDisplay);

  const row = document.createElement('div'); row.className = 'risk-row';
  const slider = document.createElement('input');
  slider.type = 'range'; slider.min = '1'; slider.max = '10'; slider.step = '1';
  slider.setAttribute('list','riskTicks');
  slider.value = '1';

  function applyFromSeverity(sev) {
    const thr = 100 - sev * 10;  // linear mapping
    currentThresholdPct = thr;   // sev=1 → 90%
    sevDisplay.textContent = String(sev);
  }
  applyFromSeverity(1);
  slider.oninput = () => applyFromSeverity(parseInt(slider.value, 10));

  row.appendChild(slider);
  container.appendChild(row);

  const ticks = document.createElement('datalist');
  ticks.id = 'riskTicks';
  for (let i=1;i<=10;i++){ const opt=document.createElement('option'); opt.value=String(i); ticks.appendChild(opt); }
  container.appendChild(ticks);
}

/* ---------- Nav ---------- */
function makeButton(label, cls, action) {
  const btn = document.createElement('button');
  btn.textContent = label; btn.className = cls; btn.onclick = action; return btn;
}
function goToNode(id) {
  closeAllPanels();
  const next = flowchart.find(n => n.id === id);
  historyStack.push(currentNode ? currentNode.id : '');
  currentNode = next; renderNode(currentNode);
}
function goBack() {
  closeAllPanels();
  const prevId = historyStack.pop();
  const prev = flowchart.find(n => n.id === prevId);
  currentNode = prev || currentNode; renderNode(currentNode);
}
function restart() {
  closeAllPanels();
  historyStack = [];
  currentSegment = "If You Should Act";
  currentNode = flowchart.find(n => n.id === "Q0");
  renderNode(currentNode);
}

/* Skip to first WHEN screen in new numbering (Q27) */
document.getElementById('skipBtn').addEventListener('click', () => {
  closeAllPanels();
  goToNode('Q27');
});

/* Initial render */
renderNode(currentNode);
</script>
</body>
</html>
