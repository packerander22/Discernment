<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Discernment Flow Chart</title>
<style>
  body { font-family: Arial, sans-serif; background: #f7f7f7; margin:0; padding:0; }
  .container { max-width: 650px; margin:auto; padding:20px; }
  .top-bar { display:flex; justify-content:space-between; margin-bottom:10px; }
  .card {
    background:#fff; padding:20px; border-radius:8px;
    box-shadow:0 2px 6px rgba(0,0,0,0.1); min-height:280px;
    display:flex; flex-direction:column; justify-content:space-between;
  }
  .segment-heading {
    font-size:1.4em; font-weight:bold; margin-bottom:15px; padding:8px;
    border-bottom:2px solid #ddd; display:flex; align-items:center; gap:8px;
    transition: background-color .5s ease, color .5s ease;
  }
  .flash-gold { background-color:gold !important; color:#fff !important; }
  .text { font-size:1.2em; margin-bottom:12px; white-space:pre-wrap; }

  .examples-toggle, .risk-toggle, .reasoning-toggle { margin:8px 0 12px 0; display:flex; gap:8px; flex-wrap:wrap; }
  .panel {
    display:none; border:1px solid #eee; border-radius:6px; padding:10px; background:#fafafa;
  }
  .panel p { margin:6px 0; }
  .panel img { width:100%; height:auto; display:block; }

  .buttons { display:flex; gap:10px; flex-wrap:wrap; justify-content:flex-start; }
  .buttons.center { justify-content:center; }

  button { flex:1; padding:10px; font-size:1em; border:none; border-radius:5px; cursor:pointer; }
  button.yes { background:#4CAF50; color:#fff; }
  button.no { background:#F44336; color:#fff; }
  button.next { background:#2196F3; color:#fff; }
  button.back { background:#555; color:#fff; flex:0 0 auto; }               /* darker */
  button.restart { background:#9C27B0; color:#fff; flex:0 0 auto; }
  button.examples-btn, button.viz-btn, button.risk-btn, button.reasoning-btn { background:#9E9E9E; color:#fff; flex:0 0 auto; } /* lighter */
  button.active { outline: 2px solid #000; }

  .risk-panel { display:none; border:1px solid #eee; border-radius:6px; padding:10px; background:#fafafa; }
  .risk-row { display:flex; align-items:center; gap:10px; margin:6px 0; }
  .risk-badge { font-weight:bold; padding:3px 6px; border-radius:4px; background:#fff; border:1px solid #ddd; }

  .error { color:#B00020; font-size:0.95em; margin-top:8px; }
</style>
</head>
<body>
<div class="container">
  <div class="top-bar">
    <button class="back" id="backBtn" onclick="goBack()">Back</button>
    <button class="restart" id="restartTop" onclick="restart()">Restart</button>
  </div>

  <div class="card">
    <div id="segmentHeading" class="segment-heading"></div>

    <div>
      <div id="text" class="text"></div>

      <!-- Examples / Viz shared panel -->
      <div id="examplesToggleWrapper" class="examples-toggle"></div>
      <div id="sharedPanel" class="panel" aria-hidden="true"></div>

      <!-- Severity slider (Q26 only) -->
      <div id="riskToggleWrapper" class="risk-toggle"></div>
      <div id="riskPanel" class="risk-panel" aria-hidden="true"></div>

      <!-- Percentage reasoning (R8/R9 only) -->
      <div id="reasoningToggleWrapper" class="reasoning-toggle"></div>
      <div id="reasoningPanel" class="panel" aria-hidden="true"></div>

      <div id="errorBox" class="error"></div>
    </div>

    <div id="buttons" class="buttons"></div>
  </div>
</div>

<script>
// ======= FLOW (Q1–Q35) =======
// NOTE: New Q26 inserted (severity). Old Q26→Q27, ... old Q34→Q35.
// Also: Q24 yes→Q28, Q25 yes→Q26, Q25 no→Q28 (to keep logic intact).
const flowchart = [
  { "id": "Q1",  "type": "question", "text": "Are there any other more important things to do or think about right now?", "yes": "R1", "no": "Q2" },
  { "id": "Q2",  "type": "question", "text": "Is there a known problem or potential QoL change that involves your needs and wants of a subject not being met functionally?", "yes": "Q5", "no": "Q3" },
  { "id": "Q3",  "type": "question", "text": "Is there cause for a potential problem that would directly affect your needs and wants of a subject not being met functionally?", "yes": "Q5", "no": "Q4" },
  { "id": "Q4",  "type": "question", "text": "Is there cause for a POTENTIAL cause for a POTENTIAL problem that would directly affect your needs and wants of a subject not being met functionally?", "yes": "Q5", "no": "R2" },
  { "id": "Q5",  "type": "question", "text": "Is there a solution to the problem/potential problem even if it’s currently unavailable (or a means of bringing about the QoL change)?", "yes": "Q6", "no": "R3" },
  { "id": "Q6",  "type": "question", "text": "Can this solution or QoL change be brought about by your influence?", "yes": "Q9", "no": "Q7" },
  { "id": "Q7",  "type": "question", "text": "Do everything in your power first to achieve the desired result, but know that past that it’s out of your hands, and worrying and obsessing won’t change anything and is unhealthy. Is there anything further you can do?", "yes": "Q9", "no": "Q8" },
  { "id": "Q8",  "type": "question", "text": "Is there an alternative solution that would solve the problem (or improve QoL) in a way that’s within your control or in a better overall way?", "yes": "R4", "no": "R2" },
  { "id": "Q9",  "type": "question", "text": "Does this solution or QoL change involve gaining information that would be valuable in the future?", "yes": "Q10", "no": "Q11" },
  { "id": "Q10", "type": "question", "text": "Would the information alone gained from doing this outweigh the downsides it would likely cause to make this happen?", "yes": "Q24", "no": "Q11" },
  { "id": "Q11", "type": "question", "text": "Is it worth your resources to solve it?", "yes": "Q13", "no": "Q12" },
  { "id": "Q12", "type": "question", "text": "Is there an alternative solution that would solve the problem (or improve QoL) in a way that’s worth it to you or in a better overall way?", "yes": "R4", "no": "R2" },
  { "id": "Q13", "type": "question", "text": "Would the benefits of addressing this issue outweigh any downsides it might likely cause?", "yes": "Q15", "no": "Q14" },
  { "id": "Q14", "type": "question", "text": "Is there an alternative solution that would solve the problem (or improve QoL) in a way that’s worth it to you or in a better overall way?", "yes": "R4", "no": "R2" },
  { "id": "Q15", "type": "question", "text": "Does addressing this issue involve a diminishing returns curve for effort applied?", "yes": "Q16", "no": "Q17" },
  { "id": "Q16", "type": "info",     "text": "Do your best to find the point of diminishing returns, then only act until that point. Have the courage to stop there. If you are prone to getting sucked into a particular activity (addressing a problem or QoL change), think of an alternative approach that also solves the problem (or improves QoL) in a different way without the addictive aspect. If a better approach is not available for whatever reason, the original approach can be used only if you pre-allocate a set time limit and use a timer after which you must stop before re-evaluating.", "next": "Q17" },
  { "id": "Q17", "type": "question", "text": "Does addressing this issue directly involve an inverted-U curve for specific effort applied with an objective sweet spot where clear information is available to you?", "yes": "Q18", "no": "Q19" },
  { "id": "Q18", "type": "info",     "text": "Wait until there aren’t any other more important things to do, then if it’s worth it to you, find that sweet spot. If not, put in as much effort as you deem worth it.", "next": "Q24" },
  { "id": "Q19", "type": "question", "text": "In practice, would a worthwhile functional difference likely be noticed if the problem/potential problem/QoL change was solved/prevented/changed (for example in a blind test compared side by side, and ignoring any differences irrelevant to the actual functionality of the intended purpose associated)?", "yes": "Q20", "no": "R2" },
  { "id": "Q20", "type": "question", "text": "Would solving/preventing it help get rid of/prevent the problem (or improve QoL) in the long term?", "yes": "Q24", "no": "Q21" },
  { "id": "Q21", "type": "question", "text": "Would solving/preventing it help get rid of/prevent the problem (or improve QoL) in the short term?", "yes": "Q22", "no": "R2" },
  { "id": "Q22", "type": "question", "text": "Is it logically worth solving/preventing EVERY time? (Or this time knowing it’s temporary?)", "yes": "Q24", "no": "Q23" },
  { "id": "Q23", "type": "question", "text": "Is there an alternative solution that would solve the problem (or improve QoL), in the long term or in a better overall way?", "yes": "R4", "no": "R2" },

  /* ===== WHEN YOU SHOULD ACT (begins here) ===== */
  { "id": "Q24", "type": "question", "text": "Does this address a current problem or potential QoL change?", "yes": "Q28", "no": "Q25" },
  { "id": "Q25", "type": "question", "text": "Does addressing this issue involve preventative maintenance?", "yes": "Q26", "no": "Q28" },

  /* NEW: Severity selection (default slider = 1). Treated as "info" with a Next. */
  { "id": "Q26", "type": "info", "text": "What would the estimated level of catastrophe be if you waited too long to act? (Level 1 being trivial, Level 10 being catastrophic)", "next": "Q27" },

  { "id": "Q27", "type": "question", "text": "Would there be clear telltale signs of future functional failure before it actually happened, with a big enough window of time to address it properly in advance?", "yes": "R8", "no": "R9" },

  { "id": "Q28", "type": "question", "text": "Is this the best solution you know of assuming you could do it now?", "yes": "Q30", "no": "Q29" },
  { "id": "Q29", "type": "question", "text": "Have you considered all better solutions you know of?", "yes": "Q30", "no": "R4" },
  { "id": "Q30", "type": "question", "text": "Is this solution currently available?", "yes": "Q34", "no": "Q32" },
  { "id": "Q31", "type": "question", "text": "Is there a better time down the road to solve/address this to maximize value?", "yes": "Q32", "no": "R6" },
  { "id": "Q32", "type": "question", "text": "Assuming you waited until it was available, would the benefits of using this solution outweigh the downsides of having to wait?", "yes": "Q35", "no": "Q33" },
  { "id": "Q33", "type": "question", "text": "Is there a next best solution?", "yes": "R4", "no": "R3" },
  { "id": "Q34", "type": "question", "text": "Is there a better time further down the road to solve/address this to maximize value?", "yes": "R7", "no": "R6" },
  { "id": "Q35", "type": "question", "text": "Is there a better time further down the road than when this solution is available to solve/address this to maximize value?", "yes": "R7", "no": "R5" },

  { "id": "R1", "type": "result", "text": "Worry about this once those things are addressed and the time is right." },
  { "id": "R2", "type": "result", "text": "Don’t worry about it." },
  { "id": "R3", "type": "result", "text": "Wait until there aren’t any other more important things to do, then if it’s worth it to you, find a solution or solutions. If not, put in as much effort as you deem worth it." },
  { "id": "R4", "type": "result", "text": "Consider any other solutions, from best to worst, if you haven’t already. Run them through the chart." },
  { "id": "R5", "type": "result", "text": "Wait until the best solution given the circumstances is available, then solve it once there aren’t any other more important things to do." },
  { "id": "R6", "type": "result", "text": "Address it sooner than later, once there aren’t any other more important things to do." },
  { "id": "R7", "type": "result", "text": "Wait until that time, then solve/address it. Consider any other options that could also work and be worth it until then." },
  { "id": "R8", "type": "result", "text": "Wait until those signs are indicated, the expected downsides of not acting now outweigh the downsides of acting now, AND the estimated chance that current functional failure is nearing or greater than 50%, then solve/address it. Consider any ways to reduce the downsides and/or the likelihood of it failing." },
  { "id": "R9", "type": "result", "text": "Wait until the expected downsides of not acting now outweigh the downsides of acting now, AND the estimated chance that current functional failure is nearing or greater than 50%, then solve/address it. Consider any ways to reduce the downsides and/or the likelihood of it failing." }
];

// ===== EXAMPLES (1 applies, 1 does not) =====
const examples = {
  Q1: [
    "Example 1: A big work/school deadline is due today, so you postpone deciding on a new TV. (Applies here)",
    "Example 2: You have a free afternoon with no pressing tasks; choosing what to fix at home can be considered now. (Does not apply here)"
  ],
  Q2: [
    "Example 1: Your sink is leaking and wasting water; the function isn’t being met. (Applies here)",
    "Example 2: Your wall paint looks slightly dull but everything works fine. (Does not apply here)"
  ],
  Q3: [
    "Example 1: Your car’s battery is slow to crank on cold mornings, hinting it could fail soon. (Applies here)",
    "Example 2: Your phone is working perfectly; you just feel uneasy it might break someday. (Does not apply here)"
  ],
  Q4: [
    "Example 1: Dust building near your PC’s intake could clog the fan, which could overheat parts. (Applies here)",
    "Example 2: A far-off storm might hit your city months from now—no current causal chain. (Does not apply here)"
  ],
  Q5: [
    "Example 1: A replacement faucet cartridge exists, even if it’s backordered. (Applies here)",
    "Example 2: An intermittent software bug has no known fix or workaround yet. (Does not apply here)"
  ],
  Q6: [
    "Example 1: You can schedule a repair and authorize payment. (Applies here)",
    "Example 2: A shipping company strike must resolve before your package moves; you can’t influence it. (Does not apply here)"
  ],
  Q7: [
    "Example 1: You can escalate a support ticket or try a recommended fix you haven’t tried. (Applies here)",
    "Example 2: You’ve done all reasonable steps; more worrying won’t change the outcome. (Does not apply here)"
  ],
  Q8: [
    "Example 1: Switch to a different app that solves the need more simply. (Applies here)",
    "Example 2: Every alternative still depends on someone else doing something outside your control. (Does not apply here)"
  ],
  Q9: [
    "Example 1: Running diagnostics teaches you how to prevent this issue later. (Applies here)",
    "Example 2: A tedious workaround teaches nothing new and won’t be useful later. (Does not apply here)"
  ],
  Q10: [
    "Example 1: A simple medical screening gives valuable info with minimal downsides. (Applies here)",
    "Example 2: Disassembling a working device ‘just to see’ risks damage for little information. (Does not apply here)"
  ],
  Q11: [
    "Example 1: A low-cost, quick fix saves time and avoids bigger costs later. (Applies here)",
    "Example 2: A very expensive fix for a tiny convenience increase. (Does not apply here)"
  ],
  Q12: [
    "Example 1: Another shop offers the same repair with a better warranty and price. (Applies here)",
    "Example 2: All other options are worse in cost, time, or reliability. (Does not apply here)"
  ],
  Q13: [
    "Example 1: Fixing a roof leak prevents damage and stress; minor cost now beats big repairs later. (Applies here)",
    "Example 2: A risky modification voids warranty for barely noticeable benefit. (Does not apply here)"
  ],
  Q14: [
    "Example 1: Replacing an old appliance is cheaper long-term than another repair. (Applies here)",
    "Example 2: No alternative provides a better outcome than the current plan. (Does not apply here)"
  ],
  Q15: [
    "Example 1: Polishing a presentation beyond ‘good enough’ gives minimal extra impact. (Applies here)",
    "Example 2: Fixing a critical bug—each hour directly improves stability; no early plateau. (Does not apply here)"
  ],
  Q17: [
    "Example 1: Exercise intensity—too little or too much hurts results; there’s a sweet spot. (Applies here)",
    "Example 2: Filing taxes—there isn’t a sweet-spot intensity; you just need to complete it. (Does not apply here)"
  ],
  Q19: [
    "Example 1: Upgrading from HDD to SSD gives a clearly noticeable speed boost. (Applies here)",
    "Example 2: Swapping to a gold-plated HDMI cable won’t change picture quality. (Does not apply here)"
  ],
  Q20: [
    "Example 1: Sealing driveway cracks extends lifespan for years. (Applies here)",
    "Example 2: A cosmetic fix that will wear off next week without changing function. (Does not apply here)"
  ],
  Q21: [
    "Example 1: Taking a decongestant lets you breathe and sleep tonight. (Applies here)",
    "Example 2: Reorganizing a drawer won’t help the urgent issue today. (Does not apply here)"
  ],
  Q22: [
    "Example 1: Wearing a seatbelt is worth doing every time. (Applies here)",
    "Example 2: Washing your car daily isn’t worth it unless there’s a special reason. (Does not apply here)"
  ],
  Q23: [
    "Example 1: Replacing a worn-out laptop beats another costly repair. (Applies here)",
    "Example 2: No alternative provides a better long-term outcome. (Does not apply here)"
  ],
  Q24: [
    "Example 1: Your phone screen is cracked now—current problem. (Applies here)",
    "Example 2: You’re just considering a nicer phone later—QoL only, not current problem. (Does not apply here)"
  ],
  Q25: [
    "Example 1: Changing HVAC filters to prevent breakdowns. (Applies here)",
    "Example 2: Repainting a wall for a new color scheme. (Does not apply here)"
  ],
  /* Q26 is an info node with slider; examples not shown in UI */
  Q27: [
    "Example 1: Brakes start squealing—clear early warning. (Applies here)",
    "Example 2: A timing belt can fail without warning—no signs to wait for. (Does not apply here)"
  ],
  Q28: [
    "Example 1: You know a proven method that would be your top choice if you could do it now. (Applies here)",
    "Example 2: You’re aware of a better option you’re not choosing. (Does not apply here)"
  ],
  Q29: [
    "Example 1: You’ve compared options and ruled out better ones. (Applies here)",
    "Example 2: You haven’t checked obvious alternatives yet. (Does not apply here)"
  ],
  Q30: [
    "Example 1: The part is in stock and appointments are open. (Applies here)",
    "Example 2: The part is backordered for two weeks. (Does not apply here)"
  ],
  Q31: [
    "Example 1: Off-season pricing or bundling will likely make it cheaper later. (Applies here)",
    "Example 2: Waiting won’t improve value—prices may rise or risks grow. (Does not apply here)"
  ],
  Q32: [
    "Example 1: Waiting a week saves a lot while causing minimal downside. (Applies here)",
    "Example 2: Waiting would cause outages or stress that outweighs savings. (Does not apply here)"
  ],
  Q33: [
    "Example 1: There’s a solid Plan B that works now. (Applies here)",
    "Example 2: No next-best option would reasonably solve it. (Does not apply here)"
  ],
  Q34: [
    "Example 1: Doing it during a scheduled break reduces disruption. (Applies here)",
    "Example 2: There’s no better window later than now. (Does not apply here)"
  ],
  Q35: [
    "Example 1: After the item becomes available, doing it during a later lull saves even more hassle. (Applies here)",
    "Example 2: Once available, sooner is clearly better—no later time beats it. (Does not apply here)"
  ]
};

// ======= STATE (severity threshold) =======
// Default to 90% (severity=1) if no stored value, per your “start at 1” preference.
const stored = parseInt(localStorage.getItem('pm_threshold_pct') || '0', 10);
let currentThresholdPct = (!isNaN(stored) && stored > 0 && stored <= 100) ? stored : 90;

// ======= APP LOGIC =======
let historyStack = [];
let currentNode = flowchart.find(n => n.id === "Q1");
let currentSegment = "If You Should Act"; // default

function getSegmentForNodeId(id) {
  if (!id || id[0] !== 'Q') return currentSegment;
  const m = /^Q(\d+)$/.exec(id);
  if (!m) return currentSegment;
  const num = parseInt(m[1], 10);
  return num >= 24 ? "When You Should Act" : "If You Should Act";
}

function flashHeading() {
  const headingDiv = document.getElementById('segmentHeading');
  headingDiv.classList.add('flash-gold');
  setTimeout(() => headingDiv.classList.remove('flash-gold'), 1500);
}
function getSegmentIcon(segment) { return segment === "If You Should Act" ? "⚖️" : "⏳"; }

function renderNode(node) {
  const errorBox = document.getElementById('errorBox');
  errorBox.textContent = '';

  if (!node) {
    errorBox.textContent = "Error: Could not render this step (missing node). Check JSON IDs and links.";
    document.getElementById('text').textContent = '';
    document.getElementById('buttons').innerHTML = '';
    collapseSharedPanel(); collapseRiskHelper(); collapseReasoningPanel();
    document.getElementById('backBtn').style.visibility = historyStack.length > 0 ? 'visible' : 'hidden';
    document.getElementById('segmentHeading').textContent = `${getSegmentIcon(currentSegment)} ${currentSegment}`;
    document.getElementById('restartTop').style.display = 'inline-block';
    return;
  }

  // Segment update AFTER landing on node
  const thisSegment = getSegmentForNodeId(node.id);
  if (thisSegment !== currentSegment) { currentSegment = thisSegment; flashHeading(); }
  document.getElementById('segmentHeading').textContent = `${getSegmentIcon(currentSegment)} ${currentSegment}`;

  // Text (with dynamic % substitution on R8/R9)
  const textDiv = document.getElementById('text');
  let displayText = node.text || '';
  if (node.id === 'R8' || node.id === 'R9') {
    displayText = displayText.replace('50%', `${currentThresholdPct}%`);
  }
  textDiv.textContent = displayText;

  // Back visibility
  document.getElementById('backBtn').style.visibility = historyStack.length > 0 ? 'visible' : 'hidden';

  // Aux UIs
  setupAuxToggles(node);  // examples & viz (Q15/Q17)
  setupRiskHelper(node);  // slider on Q26 only
  setupReasoning(node);   // chart on R8/R9

  // Buttons
  const btns = document.getElementById('buttons');
  btns.innerHTML = '';
  const restartTop = document.getElementById('restartTop');
  if (node.type === 'result') {
    restartTop.style.display = 'none';
    btns.classList.add('center');
    const restartCentered = makeButton('Restart', 'restart', () => restart());
    restartCentered.style.flex = '0 0 auto';
    btns.appendChild(restartCentered);
  } else {
    restartTop.style.display = 'inline-block';
    btns.classList.remove('center');
    if (node.type === 'question') {
      btns.appendChild(makeButton('Yes', 'yes', () => goToNode(node.yes)));
      btns.appendChild(makeButton('No', 'no', () => goToNode(node.no)));
    } else if (node.type === 'info') {
      btns.appendChild(makeButton('Next', 'next', () => goToNode(node.next)));
    }
  }
}

/* ---------- Examples + Viz (Q15/Q17 special) ---------- */
function setupAuxToggles(node) {
  const wrap = document.getElementById('examplesToggleWrapper');
  const panel = document.getElementById('sharedPanel');

  wrap.innerHTML = '';
  collapseSharedPanel();
  panel.innerHTML = '';

  if (node.type !== 'question') return;

  const isSpecial = node.id === 'Q15' || node.id === 'Q17';

  const examplesBtn = document.createElement('button');
  examplesBtn.textContent = 'Show examples';
  examplesBtn.className = 'examples-btn';
  examplesBtn.setAttribute('aria-expanded', 'false');
  wrap.appendChild(examplesBtn);

  let vizBtn = null;
  if (isSpecial) {
    vizBtn = document.createElement('button');
    vizBtn.textContent = 'Show visualization';
    vizBtn.className = 'viz-btn';
    vizBtn.setAttribute('aria-expanded', 'false');
    wrap.appendChild(vizBtn);
  }

  examplesBtn.onclick = () => {
    const isOpenExamples = panel.style.display === 'block' && panel.dataset.mode === 'examples';
    if (isOpenExamples) {
      collapseSharedPanel();
      examplesBtn.setAttribute('aria-expanded','false');
      examplesBtn.classList.remove('active');
    } else {
      renderExamples(panel, node.id);
      openSharedPanel(panel, 'examples');
      examplesBtn.setAttribute('aria-expanded','true');
      examplesBtn.classList.add('active');
      if (vizBtn) { vizBtn.setAttribute('aria-expanded','false'); vizBtn.classList.remove('active'); }
    }
  };

  if (isSpecial && vizBtn) {
    vizBtn.onclick = () => {
      const isOpenViz = panel.style.display === 'block' && panel.dataset.mode === 'viz';
      const src = node.id === 'Q15' ? 'diminishing_returns_curve.png' : 'inverted_u_curve.png';
      const alt = node.id === 'Q15'
        ? 'Diminishing Returns Curve: Effort/Resources vs Functional Results'
        : 'Inverted-U Curve: Effort/Resources vs Functional Results';
      if (isOpenViz) {
        collapseSharedPanel();
        vizBtn.setAttribute('aria-expanded','false');
        vizBtn.classList.remove('active');
      } else {
        renderViz(panel, src, alt);
        openSharedPanel(panel, 'viz');
        vizBtn.setAttribute('aria-expanded','true');
        vizBtn.classList.add('active');
        examplesBtn.setAttribute('aria-expanded','false');
        examplesBtn.classList.remove('active');
      }
    };
  }
}

function renderExamples(panel, nodeId) {
  panel.innerHTML = '';
  const two = examples[nodeId] || ["Example 1: [edit me]","Example 2: [edit me]"];
  two.forEach(line => {
    const p = document.createElement('p');
    p.textContent = line;
    panel.appendChild(p);
  });
}
function renderViz(panel, src, alt) {
  panel.innerHTML = '';
  const img = document.createElement('img'); img.src = src; img.alt = alt;
  panel.appendChild(img);
}
function collapseSharedPanel() {
  const panel = document.getElementById('sharedPanel');
  panel.style.display = 'none';
  panel.setAttribute('aria-hidden','true');
  panel.dataset.mode = '';
  const wrap = document.getElementById('examplesToggleWrapper');
  wrap.querySelectorAll('button').forEach(btn => {
    const label = btn.classList.contains('viz-btn') ? 'Show visualization' : 'Show examples';
    btn.textContent = label; btn.setAttribute('aria-expanded','false'); btn.classList.remove('active');
  });
}
function openSharedPanel(panel, mode) {
  panel.style.display = 'block';
  panel.setAttribute('aria-hidden','false');
  panel.dataset.mode = mode;
  const wrap = document.getElementById('examplesToggleWrapper');
  const exBtn = wrap.querySelector('.examples-btn');
  const vzBtn = wrap.querySelector('.viz-btn');
  if (mode === 'examples') { if (exBtn) exBtn.textContent = 'Hide examples'; if (vzBtn) vzBtn.textContent = 'Show visualization'; }
  if (mode === 'viz') { if (vzBtn) vzBtn.textContent = 'Hide visualization'; if (exBtn) exBtn.textContent = 'Show examples'; }
}

/* ---------- Risk Helper (slider only on Q26) ---------- */
function setupRiskHelper(node) {
  const wrap = document.getElementById('riskToggleWrapper');
  const panel = document.getElementById('riskPanel');
  wrap.innerHTML = ''; panel.innerHTML = ''; panel.style.display = 'none'; panel.setAttribute('aria-hidden','true');

  if (node.id !== 'Q26') return; // only on Q26

  const btn = document.createElement('button');
  btn.textContent = 'Show severity slider';
  btn.className = 'risk-btn';
  btn.setAttribute('aria-expanded','false');
  btn.onclick = () => {
    const open = panel.style.display === 'block';
    if (open) { panel.style.display='none'; panel.setAttribute('aria-hidden','true'); btn.textContent='Show severity slider'; btn.setAttribute('aria-expanded','false'); }
    else { panel.style.display='block'; panel.setAttribute('aria-hidden','false'); btn.textContent='Hide severity slider'; btn.setAttribute('aria-expanded','true'); }
  };
  wrap.appendChild(btn);

  const h = document.createElement('div');
  h.innerHTML = `<strong>Set your severity (1–10)</strong> → threshold = <em>100% − severity × 10%</em>`;
  panel.appendChild(h);

  const row = document.createElement('div'); row.className = 'risk-row';
  const label = document.createElement('label'); label.textContent = 'Severity:';
  const slider = document.createElement('input'); slider.type='range'; slider.min='1'; slider.max='10'; slider.step='1';
  // Default to severity=1 (threshold 90%) if no stored value exists
  const initial = (!isNaN(stored) && stored > 0) ? Math.max(1, Math.min(10, Math.round((100 - currentThresholdPct) / 10))) : 1;
  slider.value = String(initial);
  slider.style.flex='1';
  const sevBadge = document.createElement('span'); sevBadge.className='risk-badge'; sevBadge.textContent = slider.value;
  const thrBadge = document.createElement('span'); thrBadge.className='risk-badge'; thrBadge.textContent = `Threshold: ${100 - Number(slider.value)*10}%`;

  row.appendChild(label); row.appendChild(slider); row.appendChild(sevBadge); row.appendChild(thrBadge);
  panel.appendChild(row);

  function update() {
    const sev = parseInt(slider.value,10);
    const thr = 100 - sev*10;
    currentThresholdPct = thr;
    sevBadge.textContent = String(sev);
    thrBadge.textContent = `Threshold: ${thr}%`;
    localStorage.setItem('pm_threshold_pct', String(thr));
  }
  slider.oninput = update;

  // Ensure global threshold matches default on first view if nothing stored
  if (!(stored > 0)) {
    currentThresholdPct = 90;
    localStorage.setItem('pm_threshold_pct', '90');
  }
}
function collapseRiskHelper() {
  const panel = document.getElementById('riskPanel');
  if (!panel) return;
  panel.style.display='none'; panel.setAttribute('aria-hidden','true');
  const btn = document.getElementById('riskToggleWrapper').querySelector('button');
  if (btn) { btn.textContent='Show severity slider'; btn.setAttribute('aria-expanded','false'); }
}

/* ---------- Reasoning panel (chart on R8/R9) ---------- */
function setupReasoning(node) {
  const wrap = document.getElementById('reasoningToggleWrapper');
  const panel = document.getElementById('reasoningPanel');
  wrap.innerHTML = ''; panel.innerHTML = ''; panel.style.display='none'; panel.setAttribute('aria-hidden','true');

  if (node.id !== 'R8' && node.id !== 'R9') return;

  const btn = document.createElement('button');
  btn.textContent = 'Show percentage reasoning';
  btn.className = 'reasoning-btn';
  btn.setAttribute('aria-expanded','false');
  btn.onclick = () => {
    const open = panel.style.display === 'block';
    if (open) { panel.style.display='none'; panel.setAttribute('aria-hidden','true'); btn.textContent='Show percentage reasoning'; btn.setAttribute('aria-expanded','false'); }
    else { panel.style.display='block'; panel.setAttribute('aria-hidden','false'); btn.textContent='Hide percentage reasoning'; btn.setAttribute('aria-expanded','true'); }
  };
  wrap.appendChild(btn);

  const p = document.createElement('p');
  p.textContent = `Your current threshold is ${currentThresholdPct}%.`;
  panel.appendChild(p);

  const img = document.createElement('img');
  img.src = 'linear_threshold_chart.png';
  img.alt = 'Linear Severity to Action Threshold: Threshold = 100% − (Severity × 10%)';
  panel.appendChild(img);
}
function collapseReasoningPanel() {
  const panel = document.getElementById('reasoningPanel');
  if (!panel) return;
  panel.style.display='none'; panel.setAttribute('aria-hidden','true');
  const btn = document.getElementById('reasoningToggleWrapper').querySelector('button');
  if (btn) { btn.textContent='Show percentage reasoning'; btn.setAttribute('aria-expanded','false'); }
}

/* ---------- Nav ---------- */
function makeButton(label, cls, action) {
  const btn = document.createElement('button');
  btn.textContent = label; btn.className = cls; btn.onclick = action; return btn;
}
function goToNode(id) {
  const next = flowchart.find(n => n.id === id);
  historyStack.push(currentNode ? currentNode.id : '');
  currentNode = next; renderNode(currentNode);
}
function goBack() {
  const prevId = historyStack.pop();
  const prev = flowchart.find(n => n.id === prevId);
  currentNode = prev || currentNode; renderNode(currentNode);
}
function restart() {
  historyStack = []; currentSegment = "If You Should Act";
  currentNode = flowchart.find(n => n.id === "Q1"); renderNode(currentNode);
}

/* ---------- Start ---------- */
renderNode(currentNode);
</script>
</body>
</html>
